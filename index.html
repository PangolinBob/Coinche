<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Coinche"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>Coinche</title>

  <!-- iPhone Home Screen icon -->
  <link rel="apple-touch-icon" href="IconCoinche.png"/>
  <link rel="icon" href="IconCoinche.png"/>

  <style>
    :root{
      --bg: #ffffff;
      --fg: #111111;
      --muted: #7a7a7a;
      --line: #e6e6e6;
      --line-strong: #1a1a1a;
      --panel-w: min(320px, 82vw);
      --bar-h: 64px;
      --tap: 44px;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App layout */
    #app{
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header{
      padding: 14px 16px 10px;
    }
    .hdr{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .hdr .title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .hdr .hint{
      font-size: 14px;
      color: var(--muted);
      white-space: nowrap;
    }

    main{
      flex: 1;
      overflow: auto;
      padding: 0 10px;
      padding-bottom: calc(var(--bar-h) + env(safe-area-inset-bottom) + 14px);
    }

    /* Score sheet */
    .sheet{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
    }
	
    /* Graph view */
    #graphView{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }
    .graphCard{
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
    }
    .graphHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }
    .graphLegend{
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
      white-space: nowrap;
    }
    .graphLegend .leg{
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .graphLegend .sw{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .graphLegend .leg.nous .sw{ background: #1f6fd2; } /* Nous = bleu */
    .graphLegend .leg.eux  .sw{ background: #d21f1f; } /* Eux = rouge */

    .graphBody{
      height: min(520px, 62vh);
      padding: 10px;
    }
    #graphCanvas{
      width: 100%;
      height: 100%;
      display: block;
    }

    .sheetHeader{
      display: grid;
      grid-template-columns: 26px minmax(66px, 1fr) 54px 3px minmax(66px, 1fr) 54px;
      align-items: center;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
      padding: 8px 8px;
      gap: 0;
    }
    .sheetHeader .team{
      font-weight: 700;
      text-align: center;
	  font-size: 20px;
    }
	
	.sheetHeader .teamEux{
	  transform: translateX(18px); /* "Eux" ajuste 2–8px */
	}
	
    .sheetHeader .divider{
      height: 100%;
      background: var(--line-strong);
      border-radius: 4px;
      justify-self: stretch;
      align-self: stretch;
    }

    .rows{ width: 100%; }

    .row{
      display: grid;
      grid-template-columns: 26px minmax(66px, 1fr) 54px 3px minmax(66px, 1fr) 54px;
      align-items: center;
      padding: 8px 8px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .row:last-child{ border-bottom: none; }

    .row .no{
      color: var(--muted);
      font-size: 12px;
      text-align: left;
      padding-right: 4px;
    }
	
    .row .no.current{
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--muted);
      border-radius: 999px;
      padding-right: 0;
      color: var(--fg);
      font-weight: 700;
    }

    .divider{
      height: 100%;
      background: var(--line-strong);
      border-radius: 3px;
      justify-self: stretch;
      align-self: stretch;
    }

    .contract{
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 1px;
      min-height: 22px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
	
	.contractEux{
	  padding-left: 4px; /* ajuste 2–6px selon ton goût */
	}
	
    .contract .coinche{
      font-weight: 800;
      letter-spacing: .5px;
    }
	
	.contract.failed{
	  text-decoration: line-through;
	  text-decoration-thickness: 2px;
	  text-decoration-color: currentColor;
	}

    .totalCell{
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      line-height: 1.05;
      gap: 3px;
      min-height: 28px;
    }

    .totalCell.totalNous{
      text-align: left;
      align-items: flex-start;
    }
	
    .total{
      font-size: 17px;
      font-weight: 800;
    }
    .total.muted{
      color: var(--muted);
      font-weight: 700;
    }
	
	.total.win{
	  color: rgba(0, 150, 0, .9);
	}
	
    .tourPts{
      font-size: 12px;
      color: var(--muted);
      min-height: 14px;
    }
	
	.tourPts.win{
	  color: #1a8f2b;     /* vert lisible */
	  font-weight: 800;  /* un poil plus “winner” */
	}

    .suit{
      font-weight: 900;
      font-size: 18px;
      line-height: 1;
    }
    .suit.red{ color: #d21f1f; }
    .suit.black{ color: #111111; }
    .suit.none{ color: var(--muted); font-weight: 900; }

    .pendingMark{
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #cfcfcf;
      margin-left: 6px;
      transform: translateY(-1px);
      flex: 0 0 auto;
    }

    /* Bottom bar */
    .bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: calc(var(--bar-h) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      display: flex;
      gap: 10px;
      z-index: 50;
    }
    .bar button{
      flex: 1;
      height: var(--tap);
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      background: #fff;
      font-size: 16px;
      font-weight: 700;
      color: var(--fg);
      touch-action: manipulation;
    }
    .bar button.active{
      border-color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }

    /* Overlay + side panel */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 80;
    }
    .overlay.open{
      opacity: 1;
      pointer-events: auto;
    }

    .panel{
      position: fixed;
      top: 0; left: 0;
      width: var(--panel-w);
      height: 100%;
      background: #fff;
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index: 90;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }
    .panel.open{ transform: translateX(0); }

    .panelHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 12px 12px;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }
    .panelHeader .panelTitle{
      font-size: 20px;
      font-weight: 800;
    }
	.panelHeader .close, .graphHeader .close{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 18px;
      font-weight: 800;
      touch-action: manipulation;
    }

    .panelBody{
      padding: 12px;
      overflow: auto;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    .field{
      margin: 12px 0;
    }
    .label{
      display: block;
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    select, input{
      width: 100%;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      padding: 0 12px;
      font-size: 16px;
      background: #fff;
      color: var(--fg);
    }
    input[type="number"]{ font-variant-numeric: tabular-nums; }

    .rowInline{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .seg{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .seg button{
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #cfcfcf;
      background: #fff;
      font-weight: 800;
      touch-action: manipulation;
    }
    .seg button.on{
      border-color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }

    .suitPick{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #cfcfcf;
      border-radius: 12px;
      padding: 8px;
    }
    .suitPick button{
      flex: 1;
      height: 42px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: #fff;
      font-size: 18px;
      font-weight: 900;
      touch-action: manipulation;
    }
    .suitPick button.on{
      border-color: #111;
      background: #f6f6f6;
    }
    .suitPick button:disabled{
      opacity: .45;
    }

    .primary{
      width: 100%;
      height: 48px;
      border-radius: 14px;
	  
		border: 1px solid rgba(0,0,0,.18);
		background: rgba(144, 238, 144, .72); /* vert clair avec léger alpha */
		color: #111;
		box-shadow: 0 1px 0 rgba(0,0,0,.20);
	  
      font-size: 16px;
      font-weight: 900;
      touch-action: manipulation;
      margin-top: 10px;
    }
    .danger{
      width: 100%;
      height: 48px;
      border-radius: 14px;
      border: 1px solid #d21f1f;
      background: #fff;
      color: #d21f1f;
      font-size: 16px;
      font-weight: 900;
      touch-action: manipulation;
    }

    .helper{
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }
    .error{
      font-size: 13px;
      color: #d21f1f;
      margin-top: 8px;
      font-weight: 700;
    }

    .actionsRow{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .miniLabel{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Reduce accidental zoom on iOS when focusing inputs */
    input, select, button{ font-size: 16px; }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <div class="hdr">
        <div class="title" aria-hidden="true"></div>
        <div class="hint" id="hdrHint">Tour 1</div>
      </div>
    </header>

    <main>
	<div id="sheetView">
      <div class="sheet" aria-label="Feuille de score">
        <div class="sheetHeader">
          <div></div>
          <div class="team">Nous</div>
          <div></div>
          <div class="divider" aria-hidden="true"></div>
          <div class="team teamEux">Eux</div>
          <div></div>
        </div>
		
        <div class="rows" id="rows"></div>
      </div>
      </div>

      <div id="graphView" style="display:none;" aria-label="Graphique des scores">
        <div class="graphCard">
          <div class="graphHeader">
            <div class="graphLegend" aria-label="Légende">
              <span class="leg nous"><span class="sw" aria-hidden="true"></span>Nous</span>
              <span class="leg eux"><span class="sw" aria-hidden="true"></span>Eux</span>
            </div>
            <button class="close" id="graphClose" aria-label="Fermer">✕</button>
          </div>
          <div class="graphBody">
            <canvas id="graphCanvas"></canvas>
          </div>
        </div>
      </div>
    </main>

    <nav class="bar" aria-label="Menu">
      <button id="btnContrat" data-panel="contrat">Contrat</button>
      <button id="btnPoints" data-panel="points">Points</button>
      <button id="btnAutres" data-panel="autres">Autres</button>
    </nav>
  </div>

  <div class="overlay" id="overlay"></div>

  <aside class="panel" id="panel" aria-label="Panneau">
    <div class="panelHeader">
      <div class="panelTitle" id="panelTitle">Contrat</div>
      <button class="close" id="panelClose" aria-label="Fermer">✕</button>
    </div>
    <div class="panelBody" id="panelBody"></div>
  </aside>

  <script>
    (function(){
      'use strict';

      const STORAGE_KEY = 'coinche_app_v1';
      const MAX_HISTORY = 60;

      const TEAMS = ['Nous','Eux'];

      const SUITS = [
        {id:'spade',   sym:'♠', cls:'black'},
        {id:'club',    sym:'♣', cls:'black'},
        {id:'heart',   sym:'♥', cls:'red'},
        {id:'diamond', sym:'♦', cls:'red'},
        {id:'none',    sym:'-', cls:'none'},
      ];

      function nowISO(){ return new Date().toISOString(); }

      function emptyState(){
        return {
          version: 1,
          createdAt: nowISO(),
          tours: {}, // { [n]: { contract: {...}?, points: {Nous:number|null, Eux:number|null} } }
          undo: [],
          redo: []
        };
      }

      let state = loadState();

      // -------- Persistence ----------
      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return emptyState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== 'object') return emptyState();
          if(!parsed.tours) parsed.tours = {};
          if(!Array.isArray(parsed.undo)) parsed.undo = [];
          if(!Array.isArray(parsed.redo)) parsed.redo = [];
          return parsed;
        }catch(e){
          return emptyState();
        }
      }

      function saveState(){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }catch(e){
          // ignore (quota, private mode, etc.)
        }
      }

      // -------- Helpers ----------
      function deepClone(obj){
        return JSON.parse(JSON.stringify(obj));
      }

      function ensureTour(n){
        const k = String(n);
        if(!state.tours[k]){
          state.tours[k] = {
            contract: null,
            points: {Nous: null, Eux: null}
          };
        }else{
          if(!state.tours[k].points) state.tours[k].points = {Nous:null, Eux:null};
          if(state.tours[k].contract === undefined) state.tours[k].contract = null;
          if(state.tours[k].points.Nous === undefined) state.tours[k].points.Nous = null;
          if(state.tours[k].points.Eux === undefined) state.tours[k].points.Eux = null;
        }
        return state.tours[k];
      }

      function isFiniteNumber(x){
        return typeof x === 'number' && Number.isFinite(x);
      }

      function parseIntSafe(x){
        const n = Number.parseInt(String(x), 10);
        return Number.isFinite(n) ? n : null;
      }

      function formatSigned(n){
        if(!isFiniteNumber(n)) return '';
        if(n === 0) return '+0';
        return (n > 0 ? '+' : '') + String(n);
      }

      function suitInfo(id){
        return SUITS.find(s => s.id === id) || SUITS[0];
      }
	  
		function contractTargetPoints(c){
		  if(!c) return null;
		  if(c.kind === 'number') return isFiniteNumber(c.value) ? c.value : null;
		  if(c.kind === 'cap') return 250;
		  if(c.kind === 'gen') return 1000;
		  return null;
		}

      function currentTour(){
        // first tour (starting at 1) where points for both teams are not set
        let i = 1;
        while(true){
          const t = state.tours[String(i)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;
          if(isFiniteNumber(pn) && isFiniteNumber(pe)){
            i++;
            continue;
          }
          return i;
        }
      }

      function maxUsedTour(){
        const keys = Object.keys(state.tours || {});
        let m = 0;
        for(const k of keys){
          const n = parseIntSafe(k);
          if(n && n > m) m = n;
        }
        return m;
      }

      function displayMaxTour(){
        const m = maxUsedTour();
        const c = currentTour();
        return Math.max(10, m + 2, c + 2);
      }

      function makeUndoLabel(prefix, team, tour){
        return `${prefix} ${team} tour ${tour}`;
      }

      function pushHistory(label){
        state.undo.push({ snapshot: deepClone({tours: state.tours}), label, at: nowISO() });
        if(state.undo.length > MAX_HISTORY) state.undo.shift();
        state.redo = [];
        saveState();
      }

      function doUndo(){
        const last = state.undo.pop();
        if(!last) return;
        state.redo.push({ snapshot: deepClone({tours: state.tours}), label: last.label, at: nowISO() });
        state.tours = last.snapshot.tours || {};
        saveState();
        renderAll();
      }

      function doRedo(){
        const last = state.redo.pop();
        if(!last) return;
        state.undo.push({ snapshot: deepClone({tours: state.tours}), label: last.label, at: nowISO() });
        if(state.undo.length > MAX_HISTORY) state.undo.shift();
        state.tours = last.snapshot.tours || {};
        saveState();
        renderAll();
      }

      function resetGame(){
        state = emptyState();
        saveState();
        closePanel();
        renderAll();
      }

      // -------- Totals computation ----------
      function computeRunningTotals(maxTour){
        let totalNous = 0;
        let totalEux = 0;
        let locked = false;
        const out = {};
        for(let i=1; i<=maxTour; i++){
          const t = state.tours[String(i)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;
          const both = isFiniteNumber(pn) && isFiniteNumber(pe);

          if(!locked && both){
            totalNous += pn;
            totalEux += pe;
            out[i] = { Nous: totalNous, Eux: totalEux, computed: true };
          }else{
            if(!both) locked = true;
            out[i] = { Nous: totalNous, Eux: totalEux, computed: false };
          }
        }
        return out;
      }

      // -------- Rendering (sheet) ----------
      const elRows = document.getElementById('rows');
      const elHint = document.getElementById('hdrHint');
	  
      const elSheetView = document.getElementById('sheetView');
      const elGraphView = document.getElementById('graphView');
      const elGraphClose = document.getElementById('graphClose');
      const elGraphCanvas = document.getElementById('graphCanvas');

      let showingGraph = false;

      elGraphClose.addEventListener('click', () => {
        showingGraph = false;
        renderAll();
      });

      function renderAll(){
        const cur = currentTour();
        elHint.textContent = `Tour ${cur}`;

        if(showingGraph){
          elSheetView.style.display = 'none';
          elGraphView.style.display = 'block';
          renderGraph();
        }else{
          elGraphView.style.display = 'none';
          elSheetView.style.display = 'block';
          renderSheet();
        }
        renderBarActive();
      }

      function clearEl(el){
        while(el.firstChild) el.removeChild(el.firstChild);
      }

      function renderSheet(){
        const cur = currentTour();
        elHint.textContent = `Tour ${cur}`;

        const maxT = displayMaxTour();
        const totals = computeRunningTotals(maxT);

        clearEl(elRows);

        for(let i=1; i<=maxT; i++){
          const row = document.createElement('div');
          row.className = 'row';

          const no = document.createElement('div');
          no.className = 'no';
          no.textContent = String(i);
          if(i === cur) no.classList.add('current');
          row.appendChild(no);

          const t = ensureTour(i);

		// Contract cells
		const cNous = document.createElement('div');
		cNous.className = 'contract';
		const cEux = document.createElement('div');
		cEux.className = 'contract contractEux';

		if(t.contract && (t.contract.team === 'Nous' || t.contract.team === 'Eux')){
		  const team = t.contract.team;
		  const target = contractTargetPoints(t.contract);
		  const pts = t.points ? t.points[team] : null;

		  const failed = isFiniteNumber(target) && isFiniteNumber(pts) && pts < target;

		  if(team === 'Nous'){
			cNous.appendChild(renderContractFragment(t.contract));
			if(failed) cNous.classList.add('failed');
		  }else{
			cEux.appendChild(renderContractFragment(t.contract));
			if(failed) cEux.classList.add('failed');
		  }
		}

          // Totals + tour points
          const tn = document.createElement('div');
          tn.className = 'totalCell totalNous';

          const te = document.createElement('div');
          te.className = 'totalCell totalEux';

          const hasAnyPoints = isFiniteNumber(t.points.Nous) || isFiniteNumber(t.points.Eux);
          const showScores = (i < cur) || (i === cur && hasAnyPoints);

          const tot = totals[i] || {Nous:0,Eux:0,computed:false};

          const totalNousEl = document.createElement('div');
          totalNousEl.className = 'total' + (tot.computed ? '' : ' muted');
          totalNousEl.textContent = showScores ? String(tot.Nous) : '';

          const totalEuxEl = document.createElement('div');
          totalEuxEl.className = 'total' + (tot.computed ? '' : ' muted');
          totalEuxEl.textContent = showScores ? String(tot.Eux) : '';
		  
			// Sur le dernier tour complété (cur-1), mettre en vert le score le plus grand
			if(i === cur - 1 && showScores && tot.computed){
			  if(tot.Nous > tot.Eux) totalNousEl.classList.add('win');
			  else if(tot.Eux > tot.Nous) totalEuxEl.classList.add('win');
			}

          const ptsNous = document.createElement('div');
          ptsNous.className = 'tourPts';
          if(showScores && isFiniteNumber(t.points.Nous)) ptsNous.textContent = formatSigned(t.points.Nous);

          const ptsEux = document.createElement('div');
          ptsEux.className = 'tourPts';
          if(showScores && isFiniteNumber(t.points.Eux)) ptsEux.textContent = formatSigned(t.points.Eux);

          // pending dot only when scores are visible
          if(showScores && !tot.computed){
            const anyPts = isFiniteNumber(t.points.Nous) || isFiniteNumber(t.points.Eux);
            if(anyPts){
              const dot = document.createElement('span');
              dot.className = 'pendingMark';
              totalNousEl.appendChild(dot.cloneNode(true));
              totalEuxEl.appendChild(dot);
            }
          }

          tn.appendChild(totalNousEl);
          tn.appendChild(ptsNous);

          te.appendChild(totalEuxEl);
          te.appendChild(ptsEux);

          // Assemble row
          row.appendChild(cNous);
          row.appendChild(tn);

          const divider = document.createElement('div');
          divider.className = 'divider';
          divider.setAttribute('aria-hidden','true');
          row.appendChild(divider);

          row.appendChild(cEux);
          row.appendChild(te);

          elRows.appendChild(row);
        }
      }
	  
      function roundUp200(n){
        if(!Number.isFinite(n) || n <= 0) return 200;
        return Math.max(200, Math.ceil(n / 200) * 200);
      }

      function renderGraph(){
        const cur = currentTour();
        const xMax = Math.max(1, cur);
        const lastComplete = Math.max(0, cur - 1);

        // Courbes: on s’arrête au dernier tour complet
        const totals = computeRunningTotals(lastComplete);

        // Max Y = max score, arrondi au multiple de 200 au-dessus
        let maxVal = 0;
        for(let i=1; i<=lastComplete; i++){
          const tot = totals[i];
          if(tot && tot.computed){
            if(tot.Nous > maxVal) maxVal = tot.Nous;
            if(tot.Eux > maxVal) maxVal = tot.Eux;
          }
        }
        const yMax = roundUp200(maxVal);

        const canvas = elGraphCanvas;
        const ctx = canvas.getContext('2d');
        if(!ctx) return;

        const rect = canvas.getBoundingClientRect();
        const cssW = Math.max(10, rect.width);
        const cssH = Math.max(10, rect.height);
        const dpr = window.devicePixelRatio || 1;

        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,cssW,cssH);

        const padL = 44, padR = 24, padT = 12, padB = 30;
        const w = cssW, h = cssH;
        const pw = w - padL - padR;
        const ph = h - padT - padB;

        ctx.font = '12px -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial';
        ctx.fillStyle = 'rgba(0,0,0,.55)';

        function xToPx(x){
          if(xMax <= 1) return padL;
          return padL + ((x - 1) / (xMax - 1)) * pw;
        }
        function yToPx(y){
          const yy = Math.max(0, Math.min(yMax, y));
          return padT + (1 - (yy / yMax)) * ph;
        }

        // Grille Y: pas de 200, labels allégés si besoin
        const steps = Math.max(1, Math.round(yMax / 200));
        const labelEvery = steps > 12 ? 2 : 1;

        ctx.strokeStyle = 'rgba(0,0,0,.10)';
        ctx.lineWidth = 1;

        for(let k=0; k<=steps; k++){
          const yVal = k * 200;
          const y = yToPx(yVal);

          ctx.beginPath();
          ctx.moveTo(padL, y);
          ctx.lineTo(padL + pw, y);
          ctx.stroke();

          if(k % labelEvery === 0){
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(yVal), padL - 6, y);
          }
        }

        // Axes
        ctx.strokeStyle = 'rgba(0,0,0,.28)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, padT + ph);
        ctx.lineTo(padL + pw, padT + ph);
        ctx.stroke();

        // Labels X: tours (jusqu’au tour en cours)
        ctx.fillStyle = 'rgba(0,0,0,.55)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        const xStep = xMax <= 12 ? 1 : Math.ceil(xMax / 10);
        for(let x=1; x<=xMax; x+=xStep){
          const xx = xToPx(x);
          ctx.fillText(String(x), xx, padT + ph + 6);
        }

        function drawSeries(team, color){
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;

          let last = null;
          let started = false;

          for(let i=1; i<=lastComplete; i++){
            const tot = totals[i];
            if(!tot || !tot.computed) continue;

            const xx = xToPx(i);
            const yy = yToPx(tot[team]);

            if(!started){
              ctx.beginPath();
              ctx.moveTo(xx, yy);
              started = true;
            }else{
              ctx.lineTo(xx, yy);
            }
            last = {x: xx, y: yy, val: tot[team], tour: i};
          }

          if(started) ctx.stroke();
          return last;
        }

        const blue = '#1f6fd2'; // Nous
        const red  = '#d21f1f'; // Eux

        const lastNous = drawSeries('Nous', blue);
        const lastEux  = drawSeries('Eux',  red);

        function drawDot(pt, color){
          if(!pt) return;
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2);
          ctx.fill();
        }
        drawDot(lastNous, blue);
        drawDot(lastEux, red);

        // Score final à droite du dernier point
        let dyNous = 0, dyEux = 0;
        if(lastNous && lastEux && Math.abs(lastNous.y - lastEux.y) < 14){
          if(lastNous.y < lastEux.y){ dyNous = -8; dyEux = 8; }
          else { dyNous = 8; dyEux = -8; }
        }

        function drawEndLabel(pt, color, dy){
          if(!pt) return;
          ctx.fillStyle = color;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          const lx = Math.min(padL + pw + 6, pt.x + 8);
          const ly = pt.y + (dy || 0);
          ctx.fillText(String(pt.val), lx, ly);
        }
        drawEndLabel(lastNous, blue, dyNous);
        drawEndLabel(lastEux, red, dyEux);
      }

      function renderContractFragment(contract){
        const frag = document.createDocumentFragment();

        const coinche = contract.coinche || 'none';
        const suit = contract.suit || 'spade';

        if(contract.kind === 'number'){
          frag.appendChild(document.createTextNode(String(contract.value)));
          frag.appendChild(renderSuitSpan(suit));
        }else if(contract.kind === 'cap'){
          frag.appendChild(renderSuitSpan(suit));
          frag.appendChild(document.createTextNode('Cap'));
        }else if(contract.kind === 'gen'){
          frag.appendChild(document.createTextNode('Gén'));
          frag.appendChild(renderSuitSpan('none'));
        }else{
          frag.appendChild(document.createTextNode('—'));
        }

        if(coinche === 'C' || coinche === 'SC'){
          const c = document.createElement('span');
          c.className = 'coinche';
          c.textContent = coinche;
          frag.appendChild(c);
        }
        return frag;
      }

      function renderSuitSpan(suitId){
        const s = suitInfo(suitId);
        const sp = document.createElement('span');
        sp.className = 'suit ' + s.cls;
        sp.textContent = s.sym;
        return sp;
      }

      // -------- Panel handling ----------
      const overlay = document.getElementById('overlay');
      const panel = document.getElementById('panel');
      const panelTitle = document.getElementById('panelTitle');
      const panelBody = document.getElementById('panelBody');
      const panelClose = document.getElementById('panelClose');

      const btnContrat = document.getElementById('btnContrat');
      const btnPoints  = document.getElementById('btnPoints');
      const btnAutres  = document.getElementById('btnAutres');

      let activePanel = null; // 'contrat'|'points'|'autres'|null

      function openPanel(which){
        activePanel = which;
        panelTitle.textContent = which === 'contrat' ? 'Contrat' : (which === 'points' ? 'Points' : 'Autres');

        if(which === 'contrat') renderPanelContrat();
        if(which === 'points')  renderPanelPoints();
        if(which === 'autres')  renderPanelAutres();

        overlay.classList.add('open');
        panel.classList.add('open');
        renderBarActive();
      }

      function closePanel(){
        activePanel = null;
        overlay.classList.remove('open');
        panel.classList.remove('open');
        renderBarActive();
      }

      function renderBarActive(){
        const map = {contrat: btnContrat, points: btnPoints, autres: btnAutres};
        for(const k of Object.keys(map)){
          map[k].classList.toggle('active', activePanel === k);
        }
      }

      overlay.addEventListener('click', closePanel);
      panelClose.addEventListener('click', closePanel);

      btnContrat.addEventListener('click', () => openPanel('contrat'));
      btnPoints.addEventListener('click',  () => openPanel('points'));
      btnAutres.addEventListener('click',  () => openPanel('autres'));

      // -------- Panel: Contrat ----------
      function renderPanelContrat(){
        const cur = currentTour();

        panelBody.innerHTML = `
          <div class="field">
            <label class="label" for="cTour">Tour</label>
            <input id="cTour" type="number" min="1" step="1" inputmode="numeric"/>
          </div>

          <div class="field">
            <label class="label" for="cWho">Qui</label>
            <select id="cWho">
              <option value="Nous">Nous</option>
              <option value="Eux">Eux</option>
            </select>
          </div>

          <div class="field">
            <span class="label">Couleur</span>
            <div class="suitPick" id="cSuitPick" role="radiogroup" aria-label="Couleur">
              ${SUITS.map(s => `
                <button type="button" class="suitBtn" data-suit="${s.id}" aria-pressed="false" title="${s.sym}">
                  <span class="suit ${s.cls}">${s.sym}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="field">
            <span class="label">Points</span>
            <div class="seg" id="cKind">
              <button type="button" data-kind="number">Nombre</button>
              <button type="button" data-kind="gen">Gén</button>
              <button type="button" data-kind="cap">Cap</button>
            </div>
            <div id="cNumberWrap" style="margin-top:10px;">
              <input id="cValue" type="number" min="0" step="10" inputmode="numeric" placeholder="000"/>
            </div>
          </div>

          <div class="field">
            <label class="label" for="cCoinche">Coinché</label>
            <select id="cCoinche">
              <option value="none">—</option>
              <option value="C">Coinché</option>
              <option value="SC">Sur coinché</option>
            </select>
          </div>

          <button class="primary" id="cSave">Valider</button>
          <div class="error" id="cError" style="display:none;"></div>
        `;

        const cTour = document.getElementById('cTour');
        const cWho = document.getElementById('cWho');
        const cCoinche = document.getElementById('cCoinche');
        const cError = document.getElementById('cError');
        const suitPick = document.getElementById('cSuitPick');
        const kindWrap = document.getElementById('cKind');
        const numberWrap = document.getElementById('cNumberWrap');
        const cValue = document.getElementById('cValue');

        // Defaults
        cTour.value = String(cur);
        let selectedSuit = 'spade';
        let selectedKind = 'number';

        // Prefill if existing
        prefillContrat(cur);

        function setError(msg){
          if(!msg){
            cError.style.display = 'none';
            cError.textContent = '';
            return;
          }
          cError.style.display = 'block';
          cError.textContent = msg;
        }

        function setSuit(id){
          selectedSuit = id;
          const btns = suitPick.querySelectorAll('button.suitBtn');
          btns.forEach(b => {
            const on = b.getAttribute('data-suit') === id;
            b.classList.toggle('on', on);
            b.setAttribute('aria-pressed', on ? 'true' : 'false');
          });
        }

        function setKind(kind){
          selectedKind = kind;
          const btns = kindWrap.querySelectorAll('button');
          btns.forEach(b => b.classList.toggle('on', b.getAttribute('data-kind') === kind));
          if(kind === 'number'){
            numberWrap.style.display = 'block';
            // enable suit picker
            toggleSuitPickerDisabled(false);
          }else{
            numberWrap.style.display = 'none';
          }
          if(kind === 'gen'){
            setSuit('none');
            toggleSuitPickerDisabled(true); // only '-' is allowed
          }else if(kind === 'cap'){
            toggleSuitPickerDisabled(false);
          }
        }

        function toggleSuitPickerDisabled(disabled){
          const btns = suitPick.querySelectorAll('button.suitBtn');
          btns.forEach(b => {
            const id = b.getAttribute('data-suit');
            if(disabled){
              b.disabled = (id !== 'none');
            }else{
              b.disabled = false;
            }
          });
        }

        suitPick.addEventListener('click', (e) => {
          const btn = e.target.closest('button.suitBtn');
          if(!btn) return;
          const id = btn.getAttribute('data-suit');
          setSuit(id);
        });

        kindWrap.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-kind]');
          if(!btn) return;
          setKind(btn.getAttribute('data-kind'));
        });

        cTour.addEventListener('change', () => {
          const t = parseIntSafe(cTour.value);
          if(!t || t < 1){
            cTour.value = String(cur);
            prefillContrat(cur);
            return;
          }
          prefillContrat(t);
        });

        function prefillContrat(tour){
          ensureTour(tour);
          const t = state.tours[String(tour)];
          const c = t && t.contract ? t.contract : null;

          // reset defaults
          setKind('number');
          setSuit('spade');
          cWho.value = 'Nous';
          cCoinche.value = 'none';
          cValue.value = '';

          if(c){
            cWho.value = c.team || 'Nous';
            cCoinche.value = c.coinche || 'none';

            if(c.kind === 'number'){
              setKind('number');
              cValue.value = isFiniteNumber(c.value) ? String(c.value) : '';
              setSuit(c.suit || 'spade');
            }else if(c.kind === 'cap'){
              setKind('cap');
              setSuit(c.suit || 'spade');
            }else if(c.kind === 'gen'){
              setKind('gen');
              setSuit('none');
            }
          }
          setError('');
        }

        document.getElementById('cSave').addEventListener('click', () => {
          setError('');

          const tour = parseIntSafe(cTour.value);
          if(!tour || tour < 1){
            setError('Tour invalide.');
            return;
          }

          const team = cWho.value === 'Eux' ? 'Eux' : 'Nous';
          const coinche = cCoinche.value || 'none';

          let contract = { team, coinche: coinche === 'C' ? 'C' : (coinche === 'SC' ? 'SC' : 'none') };

          if(selectedKind === 'number'){
            const v = Number.parseInt(String(cValue.value || ''), 10);
            if(!Number.isFinite(v)){
              setError('Entre un nombre de points.');
              return;
            }
            if(selectedSuit === 'none'){
              setError('Choisis une couleur (sauf générale).');
              return;
            }
            contract.kind = 'number';
            contract.value = v;
            contract.suit = selectedSuit;
          }else if(selectedKind === 'cap'){
            if(selectedSuit === 'none'){
              setError('Choisis une couleur pour Cap.');
              return;
            }
            contract.kind = 'cap';
            contract.value = null;
            contract.suit = selectedSuit;
          }else if(selectedKind === 'gen'){
            contract.kind = 'gen';
            contract.value = null;
            contract.suit = 'none';
          }else{
            setError('Contrat invalide.');
            return;
          }

          const existing = state.tours[String(tour)] && state.tours[String(tour)].contract;
          if(existing && existing.team && existing.team !== team){
            setError('L’autre équipe est déjà partie, il faut supprimer son contrat avant d’en entrer un autre');
            return;
          }

          pushHistory(makeUndoLabel('Contrat', team, tour));
          const t = ensureTour(tour);
          t.contract = contract;
		  
			saveState();
			renderAll();
			closePanel();
        });

        // init kind default + suit highlight
        setKind(selectedKind);
        setSuit(selectedSuit);
      }

      // -------- Panel: Points ----------
      function renderPanelPoints(){
        const cur = currentTour();

        panelBody.innerHTML = `
          <div class="field">
            <label class="label" for="pTour">Tour</label>
            <input id="pTour" type="number" min="1" step="1" inputmode="numeric"/>
          </div>

          <div class="field">
            <label class="label" for="pWho">Qui</label>
            <select id="pWho">
              <option value="Nous">Nous</option>
              <option value="Eux">Eux</option>
            </select>
          </div>

          <div class="field">
            <label class="label" for="pValue">Points</label>
            <input id="pValue" type="number" step="1" inputmode="numeric" placeholder="000"/>
          </div>

          <button class="primary" id="pSave">Valider</button>
          <div class="error" id="pError" style="display:none;"></div>
          <div class="helper">Le total s’actualise quand les 2 équipes ont leurs points sur le tour.</div>
        `;

        const pTour = document.getElementById('pTour');
        const pWho = document.getElementById('pWho');
        const pValue = document.getElementById('pValue');
        const pError = document.getElementById('pError');

        pTour.value = String(cur);
        const who0 = suggestWhoForTour(cur);
        pWho.value = who0;

        prefillPoints(cur, who0);

        function setError(msg){
          if(!msg){
            pError.style.display = 'none';
            pError.textContent = '';
            return;
          }
          pError.style.display = 'block';
          pError.textContent = msg;
        }
		
        function suggestWhoForTour(tour){
          const t = state.tours[String(tour)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;

          const hasNous = isFiniteNumber(pn);
          const hasEux  = isFiniteNumber(pe);

          // Aucun point sur le tour : on prend l’équipe partie (contrat) si dispo
          if(!hasNous && !hasEux){
            const ct = t && t.contract ? t.contract.team : null;
            return (ct === 'Nous' || ct === 'Eux') ? ct : 'Nous';
          }

          // Un seul côté rempli : on propose l’autre
          if(hasNous && !hasEux) return 'Eux';
          if(!hasNous && hasEux) return 'Nous';

          // Sinon : défaut
          return 'Nous';
        }

        function prefillPoints(tour, team){
          ensureTour(tour);
          const t = state.tours[String(tour)];
          const v = t && t.points ? t.points[team] : null;
          pValue.value = isFiniteNumber(v) ? String(v) : '';
          setError('');
        }

        pTour.addEventListener('change', () => {
          const tour = parseIntSafe(pTour.value);
          if(!tour || tour < 1){
            pTour.value = String(cur);
            const who = suggestWhoForTour(cur);
            pWho.value = who;
            prefillPoints(cur, who);
            return;
          }
          const who = suggestWhoForTour(tour);
          pWho.value = who;
          prefillPoints(tour, who);
        });

        pWho.addEventListener('change', () => {
          const tour = parseIntSafe(pTour.value) || cur;
          prefillPoints(tour, pWho.value);
        });

        document.getElementById('pSave').addEventListener('click', () => {
          setError('');

          const tour = parseIntSafe(pTour.value);
          if(!tour || tour < 1){
            setError('Tour invalide.');
            return;
          }
          const team = pWho.value === 'Eux' ? 'Eux' : 'Nous';
          const v = Number.parseInt(String(pValue.value || ''), 10);
          if(!Number.isFinite(v)){
            setError('Entre un nombre de points.');
            return;
          }
		  
          const before = state.tours[String(tour)];
          const wasComplete = !!(before && before.points && isFiniteNumber(before.points.Nous) && isFiniteNumber(before.points.Eux));

          pushHistory(makeUndoLabel('Points', team, tour));
          const t = ensureTour(tour);
          t.points[team] = v;

			saveState();
			renderAll();

          const nowComplete = isFiniteNumber(t.points.Nous) && isFiniteNumber(t.points.Eux);

          // Si on vient de compléter le tour (2 équipes), on ferme
          if(!wasComplete && nowComplete){
            closePanel();
            return;
          }

          // Sinon, on prépare la saisie suivante (souvent l’autre équipe)
          if(!nowComplete){
            const nextTeam = suggestWhoForTour(tour);
            pWho.value = nextTeam;
            prefillPoints(tour, nextTeam);
          }else{
            prefillPoints(tour, team);
          }

          pValue.focus();
          pValue.select();
		  
        });
      }

      // -------- Panel: Autres ----------
      function renderPanelAutres(){
        const undoLabel = state.undo.length ? state.undo[state.undo.length-1].label : '—';

        panelBody.innerHTML = `
          <div class="actionsRow">
            <button class="danger" id="aReset">Nouvelle partie</button>
          </div>

          <div class="field" style="margin-top:18px;">
            <button class="primary" id="aUndo" ${state.undo.length ? '' : 'disabled'}>Undo</button>
            <div class="miniLabel">Dernier : ${escapeHtml(undoLabel)}</div>
          </div>
		  
          <div class="field">
            <button class="primary" id="aGraph">Graphique</button>
          </div>

        `;

        document.getElementById('aReset').addEventListener('click', () => {
          const ok = confirm('Nouvelle partie : tu confirmes ?');
          if(ok) resetGame();
        });

        const undoBtn = document.getElementById('aUndo');

        undoBtn.addEventListener('click', () => {
          doUndo();
          // rerender panel to update labels
          renderPanelAutres();
        });
		
        document.getElementById('aGraph').addEventListener('click', () => {
          showingGraph = true;
          closePanel();
          renderAll();
        });
		
      }

      function escapeHtml(s){
        return String(s || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      // Initial render
      renderAll();
	  
      window.addEventListener('resize', () => {
        if(showingGraph) renderGraph();
      });

      // Keyboard: Esc closes panel (desktop)
      window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && activePanel) closePanel();
      });

    })();
  </script>
</body>
</html>
