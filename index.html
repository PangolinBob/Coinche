<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Coinche"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>Coinche</title>

  <!-- iPhone Home Screen icon -->
  <link rel="apple-touch-icon" href="IconCoinche.png"/>
  <link rel="icon" href="IconCoinche.png"/>

  <style>
    :root{
      --bg: #ffffff;
      --fg: #111111;
      --muted: #7a7a7a;
      --line: #e6e6e6;
      --line-strong: #1a1a1a;
		--blue-rgb: 31, 111, 210; /* m√™me bleu que le graphe Nous (#1f6fd2) */
		--red-rgb: 210, 31, 31;
      --panel-w: min(320px, 82vw);
      --bar-h: 64px;
      --tap: 44px;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App layout */
    #app{
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header{
      padding: 14px 16px 10px;
    }
    .hdr{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .hdr .title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .hdr .hint{
      font-size: 14px;
      color: var(--muted);
      white-space: nowrap;
    }

    main{
      flex: 1;
      overflow: auto;
      padding: 0 10px;
      padding-bottom: calc(var(--bar-h) + env(safe-area-inset-bottom) + 14px);
    }

    /* Score sheet */
    .sheet{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
    }
	
    /* Graph view */
    #graphView{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }
    .graphCard{
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
    }
    .graphHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }
    .graphLegend{
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
      white-space: nowrap;
    }
    .graphLegend .leg{
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .graphLegend .sw{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .graphLegend .leg.nous .sw{ background: #1f6fd2; } /* Nous = bleu */
    .graphLegend .leg.eux  .sw{ background: #d21f1f; } /* Eux = rouge */

    .graphBody{
      height: min(520px, 62vh);
      padding: 10px;
    }
    #graphCanvas{
      width: 100%;
      height: 100%;
      display: block;
    }
	
    /* Stats view */
    #statsView{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
    }
    .statsCard{
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
    }
    .statsHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }
    .statsTitle{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .statsBody{
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .statCard{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      padding: 12px;
    }
    .statHead{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }
    .statHeadTitle{
      font-size: 13px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing: .2px;
    }
    .statHeadSub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .scoreRow{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .scoreBox{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
    }
    .scoreBox.nous{
      border-color: rgba(var(--blue-rgb), .22);
      background: rgba(var(--blue-rgb), .08);
    }
    .scoreBox.eux{
      border-color: rgba(var(--red-rgb), .22);
      background: rgba(var(--red-rgb), .08);
    }
    .scoreName{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }
    .scoreVal{
      font-size: 28px;
      font-weight: 900;
      margin-top: 4px;
      font-variant-numeric: tabular-nums;
    }

    .deltaRow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fafafa;
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    .pill.blue{
      border-color: rgba(var(--blue-rgb), .25);
      background: rgba(var(--blue-rgb), .14);
    }
    .pill.red{
      border-color: rgba(var(--red-rgb), .25);
      background: rgba(var(--red-rgb), .14);
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .kpiGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: #fff;
    }
    .kpiLabel{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpiValue{
      font-size: 18px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    .kpiUnit{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-left: 4px;
    }
    .kpiMini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      font-weight: 800;
    }

    .barWrap{
      height: 10px;
      border-radius: 999px;
      background: #f2f2f2;
      border: 1px solid var(--line);
      overflow: hidden;
      margin-top: 6px;
    }
    .barFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(var(--blue-rgb), .45);
    }
    .barFill.red{
      background: rgba(var(--red-rgb), .45);
    }

    .contractInline{
      font-weight: 900;
      white-space: nowrap;
    }
    .contractInline .coinche{
      font-weight: 900;
      margin-left: 2px;
    }

    .champList{
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .champItem{
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .champItem .emoji{
      width: 22px;
      text-align: center;
      font-size: 18px;
      line-height: 1.2;
    }
    .champItem .txt{
      font-size: 14px;
      line-height: 1.25;
    }
    .champItem .txt .muted{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      margin-left: 4px;
    }

    .donorNow{
      font-size: 14px;
      font-weight: 900;
      margin-bottom: 10px;
    }
    .dealCounts{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .dealCount{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-variant-numeric: tabular-nums;
    }
    .dealCount.on{
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(144, 238, 144, .22);
    }
    .dealCount .who{
      font-weight: 900;
    }
    .dealCount .num{
      font-weight: 900;
      color: var(--muted);
    }

    .sheetHeader{
      display: grid;
      grid-template-columns: 26px minmax(66px, 1fr) 54px 3px minmax(66px, 1fr) 54px;
      align-items: center;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
      padding: 8px 8px;
      gap: 0;
    }
    .sheetHeader .team{
      font-weight: 700;
      text-align: center;
	  font-size: 20px;
    }
	
	.sheetHeader .teamEux{
	  transform: translateX(18px); /* "Eux" ajuste 2‚Äì8px */
	}
	
    .sheetHeader .divider{
      height: 100%;
      background: var(--line-strong);
      border-radius: 4px;
      justify-self: stretch;
      align-self: stretch;
    }

    .rows{ width: 100%; }

    .row{
      display: grid;
      grid-template-columns: 26px minmax(66px, 1fr) 54px 3px minmax(66px, 1fr) 54px;
      align-items: center;
      padding: 8px 8px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
	
    .row.currentRow{
      background: rgba(144, 238, 144, .22); /* m√™me vert que "Valider", plus transparent */
    }
	
    .row:last-child{ border-bottom: none; }

    .row .no{
      color: var(--muted);
      font-size: 12px;
      text-align: left;
      padding-right: 4px;
    }
	
    .row .no.current{
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--muted);
      border-radius: 999px;
      padding-right: 0;
      color: var(--fg);
      font-weight: 700;
    }

    .divider{
      height: 100%;
      background: var(--line-strong);
      border-radius: 3px;
      justify-self: stretch;
      align-self: stretch;
    }

    .contract{
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 1px;
      min-height: 22px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
	
	.contractEux{
	  padding-left: 4px; /* ajuste 2‚Äì6px selon ton go√ªt */
	}
	
    .contract .coinche{
      font-weight: 800;
      letter-spacing: .5px;
    }
	
	.contract.failed{
	  text-decoration: line-through;
	  text-decoration-thickness: 2px;
	  text-decoration-color: currentColor;
	}

    .totalCell{
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      line-height: 1.05;
      gap: 3px;
      min-height: 28px;
    }

    .totalCell.totalNous{
      text-align: left;
      align-items: flex-start;
    }
	
    .total{
      font-size: 17px;
      font-weight: 800;
    }
    .total.muted{
      color: var(--muted);
      font-weight: 700;
    }
	
	.total.win{
	  color: rgba(0, 150, 0, .9);
	}
	
    .tourPts{
      font-size: 12px;
      color: var(--muted);
      min-height: 14px;
    }
	
	.tourPts.win{
	  color: #1a8f2b;     /* vert lisible */
	  font-weight: 800;  /* un poil plus ‚Äúwinner‚Äù */
	}

    .suit{
      font-weight: 900;
      font-size: 18px;
      line-height: 1;
    }
    .suit.red{ color: #d21f1f; }
    .suit.black{ color: #111111; }
    .suit.none{ color: var(--muted); font-weight: 900; }

    .pendingMark{
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #cfcfcf;
      margin-left: 6px;
      transform: translateY(-1px);
      flex: 0 0 auto;
    }
	
    /* Qui donne (en bas √† droite de la feuille) */
    .dealerGrid{
      position: fixed;
      right: 12px;
      bottom: calc(var(--bar-h) + env(safe-area-inset-bottom) + 14px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      z-index: 45;
    }
    .dealerCell{
      width: 54px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 800;
      color: var(--fg);
      user-select: none;
    }
    .dealerCell.on{
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(144, 238, 144, .72); /* m√™me vert que "Valider" */
      box-shadow: 0 1px 0 rgba(0,0,0,.20);
    }

    /* Bottom bar */
    .bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: calc(var(--bar-h) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      display: flex;
      gap: 10px;
      z-index: 50;
    }
    .bar button{
		transition: background-color .12s ease, border-color .12s ease, transform .06s ease;
		box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      flex: 1;
      height: var(--tap);
      border-radius: 12px;
      border: 1px solid rgba(var(--blue-rgb), .25);
      background: rgba(var(--blue-rgb), .18);
      font-size: 16px;
      font-weight: 700;
      color: #111;
      touch-action: manipulation;
    }
    .bar button.active{
      border-color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }

    /* Overlay + side panel */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 80;
    }
    .overlay.open{
      opacity: 1;
      pointer-events: auto;
    }

    .panel{
      position: fixed;
      top: 0; left: 0;
      width: var(--panel-w);
      height: 100%;
      background: #fff;
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index: 90;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }
    .panel.open{ transform: translateX(0); }

    .panelHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 12px 12px;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }
    .panelHeader .panelTitle{
      font-size: 20px;
      font-weight: 800;
    }
	.panelHeader .close, .graphHeader .close, .statsHeader .close{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 18px;
      font-weight: 800;
      touch-action: manipulation;
    }

    .panelBody{
      padding: 12px;
      overflow: auto;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    .field{
      margin: 12px 0;
    }
    .label{
      display: block;
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    select, input{
      width: 100%;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      padding: 0 12px;
      font-size: 16px;
      background: #fff;
      color: var(--fg);
    }
    input[type="number"]{ font-variant-numeric: tabular-nums; }

    .rowInline{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .seg{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .seg button{
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #cfcfcf;
      background: #fff;
      font-weight: 800;
      touch-action: manipulation;
    }
    .seg button.on{
      border-color: #111;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }

    .suitPick{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #cfcfcf;
      border-radius: 12px;
      padding: 8px;
    }
    .suitPick button{
      flex: 1;
      height: 42px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: #fff;
      font-size: 18px;
      font-weight: 900;
      touch-action: manipulation;
    }
    .suitPick button.on{
      border-color: #111;
      background: #f6f6f6;
    }
    .suitPick button:disabled{
      opacity: .45;
    }

    .primary{
      width: 100%;
      height: 48px;
      border-radius: 14px;
	  
		border: 1px solid rgba(0,0,0,.18);
		background: rgba(144, 238, 144, .72); /* vert clair avec l√©ger alpha */
		color: #111;
		box-shadow: 0 1px 0 rgba(0,0,0,.20);
	  
      font-size: 16px;
      font-weight: 900;
      touch-action: manipulation;
      margin-top: 10px;
    }
    .danger{
      width: 100%;
      height: 48px;
      border-radius: 14px;
      border: 1px solid #d21f1f;
      background: #fff;
      color: #d21f1f;
      font-size: 16px;
      font-weight: 900;
      touch-action: manipulation;
    }

    .helper{
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }
    .error{
      font-size: 13px;
      color: #d21f1f;
      margin-top: 8px;
      font-weight: 700;
    }

    .actionsRow{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .miniLabel{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Reduce accidental zoom on iOS when focusing inputs */
    input, select, button{ font-size: 16px; }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <div class="hdr">
        <div class="title" aria-hidden="true"></div>
        <div class="hint" id="hdrHint">Tour 1</div>
      </div>
    </header>

    <main>
	<div id="sheetView">
      <div class="sheet" aria-label="Feuille de score">
        <div class="sheetHeader">
          <div></div>
          <div class="team">Nous</div>
          <div></div>
          <div class="divider" aria-hidden="true"></div>
          <div class="team teamEux">Eux</div>
          <div></div>
        </div>
		
        <div class="rows" id="rows"></div>
      </div>

      <div id="dealerGrid" class="dealerGrid" aria-label="Qui donne"></div>
      </div>

      <div id="graphView" style="display:none;" aria-label="Graphique des scores">
        <div class="graphCard">
          <div class="graphHeader">
            <div class="graphLegend" aria-label="L√©gende">
              <span class="leg nous"><span class="sw" aria-hidden="true"></span>Nous</span>
              <span class="leg eux"><span class="sw" aria-hidden="true"></span>Eux</span>
            </div>
            <button class="close" id="graphClose" aria-label="Fermer">‚úï</button>
          </div>
          <div class="graphBody">
            <canvas id="graphCanvas"></canvas>
          </div>
        </div>
      </div>
	  
      <div id="statsView" style="display:none;" aria-label="Statistiques">
        <div class="statsCard">
          <div class="statsHeader">
            <div class="statsTitle">Statistiques</div>
            <button class="close" id="statsClose" aria-label="Fermer">‚úï</button>
          </div>
          <div class="statsBody" id="statsBody"></div>
        </div>
      </div>
	  
    </main>

    <nav class="bar" aria-label="Menu">
      <button id="btnContrat" data-panel="contrat">Contrat</button>
      <button id="btnPoints" data-panel="points">Points</button>
      <button id="btnAutres" data-panel="autres">Autres</button>
    </nav>
  </div>

  <div class="overlay" id="overlay"></div>

  <aside class="panel" id="panel" aria-label="Panneau">
    <div class="panelHeader">
      <div class="panelTitle" id="panelTitle">Contrat</div>
      <button class="close" id="panelClose" aria-label="Fermer">‚úï</button>
    </div>
    <div class="panelBody" id="panelBody"></div>
  </aside>

  <script>
    (function(){
      'use strict';

      const STORAGE_KEY = 'coinche_app_v1';
      const MAX_HISTORY = 60;

      const TEAMS = ['Nous','Eux'];
      const PRESET_PLAYERS = ['Arnaud','Boris','Ga√´l','Lionel'];
      const OTHER_VALUE = '__other__';

      const SUITS = [
        {id:'spade',   sym:'‚ô†', cls:'black'},
        {id:'club',    sym:'‚ô£', cls:'black'},
        {id:'heart',   sym:'‚ô•', cls:'red'},
        {id:'diamond', sym:'‚ô¶', cls:'red'},
        {id:'none',    sym:'-', cls:'none'},
      ];

      function nowISO(){ return new Date().toISOString(); }

      function emptyState(){
        return {
          version: 1,
          createdAt: nowISO(),
          players: PRESET_PLAYERS.slice(),
          dealerAnchorTour: 1,   // tour √† partir duquel on recale le donneur
          dealerAnchorIndex: 0,  // index (0..3) du donneur sur dealerAnchorTour
          tours: {}, // { [n]: { contract: {...}?, points: {Nous:number|null, Eux:number|null} } }
          undo: [],
          redo: []
        };
      }

      let state = loadState();

      // -------- Persistence ----------
      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return emptyState();
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== 'object') return emptyState();
          if(!parsed.tours) parsed.tours = {};
          if(!Array.isArray(parsed.undo)) parsed.undo = [];
          if(!Array.isArray(parsed.redo)) parsed.redo = [];
		  
          // Placement / donneur
          if(!Array.isArray(parsed.players) || parsed.players.length !== 4){
            parsed.players = PRESET_PLAYERS.slice();
          }else{
            parsed.players = parsed.players.map((v, i) => {
              const s = String((v === null || v === undefined) ? '' : v).trim();
              return s ? s : PRESET_PLAYERS[i];
            });
            // si ancien √©tat "Joueur 1..4", on remplace par les pr√©noms par d√©faut
            const wasPlaceholders = parsed.players.every((name, i) => name === `Joueur ${i+1}`);
            if(wasPlaceholders) parsed.players = PRESET_PLAYERS.slice();
          }

          // Donneur : on ancre la rotation sur un tour
          const hasAnchor =
            (typeof parsed.dealerAnchorTour === 'number' && Number.isFinite(parsed.dealerAnchorTour) && parsed.dealerAnchorTour >= 1) &&
            (typeof parsed.dealerAnchorIndex === 'number' && Number.isFinite(parsed.dealerAnchorIndex) && parsed.dealerAnchorIndex >= 0 && parsed.dealerAnchorIndex <= 3);

          if(!hasAnchor){
            const d = parsed.dealerStartIndex; // compat ancienne version
            parsed.dealerAnchorTour = 1;
            parsed.dealerAnchorIndex = (typeof d === 'number' && Number.isFinite(d) && d >= 0 && d <= 3) ? d : 0;
          }
		  
          return parsed;
        }catch(e){
          return emptyState();
        }
      }

      function saveState(){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }catch(e){
          // ignore (quota, private mode, etc.)
        }
      }

      // -------- Helpers ----------
      function deepClone(obj){
        return JSON.parse(JSON.stringify(obj));
      }

      function ensureTour(n){
        const k = String(n);
        if(!state.tours[k]){
          state.tours[k] = {
            contract: null,
            points: {Nous: null, Eux: null}
          };
        }else{
          if(!state.tours[k].points) state.tours[k].points = {Nous:null, Eux:null};
          if(state.tours[k].contract === undefined) state.tours[k].contract = null;
          if(state.tours[k].points.Nous === undefined) state.tours[k].points.Nous = null;
          if(state.tours[k].points.Eux === undefined) state.tours[k].points.Eux = null;
        }
        return state.tours[k];
      }

      function isFiniteNumber(x){
        return typeof x === 'number' && Number.isFinite(x);
      }

      function parseIntSafe(x){
        const n = Number.parseInt(String(x), 10);
        return Number.isFinite(n) ? n : null;
      }

      function formatSigned(n){
        if(!isFiniteNumber(n)) return '';
        if(n === 0) return '+0';
        return (n > 0 ? '+' : '') + String(n);
      }

      function suitInfo(id){
        return SUITS.find(s => s.id === id) || SUITS[0];
      }
	  
		function contractTargetPoints(c){
		  if(!c) return null;
		  if(c.kind === 'number') return isFiniteNumber(c.value) ? c.value : null;
		  if(c.kind === 'cap') return 250;
		  if(c.kind === 'gen') return 1000;
		  return null;
		}
		
      function playersDefault(){
        return PRESET_PLAYERS.slice();
      }

      function normalizePlayers(arr){
        const def = playersDefault();
        if(!Array.isArray(arr) || arr.length !== 4) return def.slice();
        const out = [];
        for(let i=0; i<4; i++){
          const s = String((arr[i] === null || arr[i] === undefined) ? '' : arr[i]).trim();
          out.push(s ? s : def[i]);
        }
        return out;
      }

      function twoLetters(name){
        const raw = String(name || '').trim();
        if(!raw) return '--';
        const compact = raw.replace(/\s+/g,'');
        const chars = Array.from(compact);
        return chars.slice(0,2).join('') || '--';
      }

      function dealerIndexForTour(tour){
        const anchorTour =
          (typeof state.dealerAnchorTour === 'number' && Number.isFinite(state.dealerAnchorTour) && state.dealerAnchorTour >= 1)
            ? state.dealerAnchorTour
            : 1;
        const anchorIndex =
          (typeof state.dealerAnchorIndex === 'number' && Number.isFinite(state.dealerAnchorIndex) && state.dealerAnchorIndex >= 0 && state.dealerAnchorIndex <= 3)
            ? state.dealerAnchorIndex
            : 0;

        const t = Number.parseInt(String(tour), 10);
        if(!Number.isFinite(t) || t < 1) return anchorIndex;

        const delta = t - anchorTour;
        return ((anchorIndex + delta) % 4 + 4) % 4; // modulo positif
      }

      function currentTour(){
        // first tour (starting at 1) where points for both teams are not set
        let i = 1;
        while(true){
          const t = state.tours[String(i)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;
          if(isFiniteNumber(pn) && isFiniteNumber(pe)){
            i++;
            continue;
          }
          return i;
        }
      }

      function maxUsedTour(){
        const keys = Object.keys(state.tours || {});
        let m = 0;
        for(const k of keys){
          const n = parseIntSafe(k);
          if(n && n > m) m = n;
        }
        return m;
      }

      function displayMaxTour(){
        const m = maxUsedTour();
        const c = currentTour();
        return Math.max(10, m + 2, c + 2);
      }

      function makeUndoLabel(prefix, team, tour){
        return `${prefix} ${team} tour ${tour}`;
      }

      function pushHistory(label){
        state.undo.push({ snapshot: deepClone({tours: state.tours}), label, at: nowISO() });
        if(state.undo.length > MAX_HISTORY) state.undo.shift();
        state.redo = [];
        saveState();
      }

      function doUndo(){
        const last = state.undo.pop();
        if(!last) return;
        state.redo.push({ snapshot: deepClone({tours: state.tours}), label: last.label, at: nowISO() });
        state.tours = last.snapshot.tours || {};
        saveState();
        renderAll();
      }

      function doRedo(){
        const last = state.redo.pop();
        if(!last) return;
        state.undo.push({ snapshot: deepClone({tours: state.tours}), label: last.label, at: nowISO() });
        if(state.undo.length > MAX_HISTORY) state.undo.shift();
        state.tours = last.snapshot.tours || {};
        saveState();
        renderAll();
      }

      function resetGame(){
        state = emptyState();
        saveState();
        closePanel();
        renderAll();
      }

      // -------- Totals computation ----------
      function computeRunningTotals(maxTour){
        let totalNous = 0;
        let totalEux = 0;
        let locked = false;
        const out = {};
        for(let i=1; i<=maxTour; i++){
          const t = state.tours[String(i)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;
          const both = isFiniteNumber(pn) && isFiniteNumber(pe);

          if(!locked && both){
            totalNous += pn;
            totalEux += pe;
            out[i] = { Nous: totalNous, Eux: totalEux, computed: true };
          }else{
            if(!both) locked = true;
            out[i] = { Nous: totalNous, Eux: totalEux, computed: false };
          }
        }
        return out;
      }

      // -------- Rendering (sheet) ----------
      const elRows = document.getElementById('rows');
      const elHint = document.getElementById('hdrHint');
	  
      const elSheetView = document.getElementById('sheetView');
      const elGraphView = document.getElementById('graphView');
      const elGraphClose = document.getElementById('graphClose');
      const elGraphCanvas = document.getElementById('graphCanvas');
      const elDealerGrid = document.getElementById('dealerGrid');
      const elStatsView = document.getElementById('statsView');
      const elStatsClose = document.getElementById('statsClose');
      const elStatsBody = document.getElementById('statsBody');

      let showingGraph = false;
      let showingStats = false;
      let placementOpen = false;

      elGraphClose.addEventListener('click', () => {
        showingGraph = false;
        renderAll();
      });
	  
      elStatsClose.addEventListener('click', () => {
        showingStats = false;
        renderAll();
      });

      function renderAll(){
        const cur = currentTour();
        elHint.textContent = `Tour ${cur}`;

        if(showingGraph){
          elSheetView.style.display = 'none';
          elStatsView.style.display = 'none';
          elGraphView.style.display = 'block';
          renderGraph();
        }else if(showingStats){
          elSheetView.style.display = 'none';
          elGraphView.style.display = 'none';
          elStatsView.style.display = 'block';
          renderStats();
        }else{
          elGraphView.style.display = 'none';
          elStatsView.style.display = 'none';
          elSheetView.style.display = 'block';
          renderSheet();
        }

        renderBarActive();
      }

      function clearEl(el){
        while(el.firstChild) el.removeChild(el.firstChild);
      }
	  
      function renderDealerGrid(){
        if(!elDealerGrid) return;

        // Normalise + persist
        state.players = normalizePlayers(state.players);

        const cur = currentTour();
        const idx = dealerIndexForTour(cur);

        clearEl(elDealerGrid);

        for(let i=0; i<4; i++){
          const cell = document.createElement('div');
          cell.className = 'dealerCell' + (i === idx ? ' on' : '');
          cell.textContent = twoLetters(state.players[i]);
          cell.title = state.players[i];
          elDealerGrid.appendChild(cell);
        }
      }

      function renderSheet(){
        const cur = currentTour();
        elHint.textContent = `Tour ${cur}`;

        const maxT = displayMaxTour();
        const totals = computeRunningTotals(maxT);

        clearEl(elRows);

        for(let i=1; i<=maxT; i++){
          const row = document.createElement('div');
          row.className = 'row';
			if(i === cur) row.classList.add('currentRow');

          const no = document.createElement('div');
          no.className = 'no';
          no.textContent = String(i);
          if(i === cur) no.classList.add('current');
          row.appendChild(no);

          const t = ensureTour(i);

		// Contract cells
		const cNous = document.createElement('div');
		cNous.className = 'contract';
		const cEux = document.createElement('div');
		cEux.className = 'contract contractEux';

		if(t.contract && (t.contract.team === 'Nous' || t.contract.team === 'Eux')){
		  const team = t.contract.team;
		  const target = contractTargetPoints(t.contract);
		  const pts = t.points ? t.points[team] : null;

		  const failed = isFiniteNumber(target) && isFiniteNumber(pts) && pts < target;

		  if(team === 'Nous'){
			cNous.appendChild(renderContractFragment(t.contract));
			if(failed) cNous.classList.add('failed');
		  }else{
			cEux.appendChild(renderContractFragment(t.contract));
			if(failed) cEux.classList.add('failed');
		  }
		}

          // Totals + tour points
          const tn = document.createElement('div');
          tn.className = 'totalCell totalNous';

          const te = document.createElement('div');
          te.className = 'totalCell totalEux';

          const hasAnyPoints = isFiniteNumber(t.points.Nous) || isFiniteNumber(t.points.Eux);
          const showScores = (i < cur) || (i === cur && hasAnyPoints);

          const tot = totals[i] || {Nous:0,Eux:0,computed:false};

          const totalNousEl = document.createElement('div');
          totalNousEl.className = 'total' + (tot.computed ? '' : ' muted');
          totalNousEl.textContent = showScores ? String(tot.Nous) : '';

          const totalEuxEl = document.createElement('div');
          totalEuxEl.className = 'total' + (tot.computed ? '' : ' muted');
          totalEuxEl.textContent = showScores ? String(tot.Eux) : '';
		  
			// Sur le dernier tour compl√©t√© (cur-1), mettre en vert le score le plus grand
			if(i === cur - 1 && showScores && tot.computed){
			  if(tot.Nous > tot.Eux) totalNousEl.classList.add('win');
			  else if(tot.Eux > tot.Nous) totalEuxEl.classList.add('win');
			}

          const ptsNous = document.createElement('div');
          ptsNous.className = 'tourPts';
          if(showScores && isFiniteNumber(t.points.Nous)) ptsNous.textContent = formatSigned(t.points.Nous);

          const ptsEux = document.createElement('div');
          ptsEux.className = 'tourPts';
          if(showScores && isFiniteNumber(t.points.Eux)) ptsEux.textContent = formatSigned(t.points.Eux);

          // pending dot only when scores are visible
          if(showScores && !tot.computed){
            const anyPts = isFiniteNumber(t.points.Nous) || isFiniteNumber(t.points.Eux);
            if(anyPts){
              const dot = document.createElement('span');
              dot.className = 'pendingMark';
              totalNousEl.appendChild(dot.cloneNode(true));
              totalEuxEl.appendChild(dot);
            }
          }

          tn.appendChild(totalNousEl);
          tn.appendChild(ptsNous);

          te.appendChild(totalEuxEl);
          te.appendChild(ptsEux);

          // Assemble row
          row.appendChild(cNous);
          row.appendChild(tn);

          const divider = document.createElement('div');
          divider.className = 'divider';
          divider.setAttribute('aria-hidden','true');
          row.appendChild(divider);

          row.appendChild(cEux);
          row.appendChild(te);

          elRows.appendChild(row);
        }

        renderDealerGrid();
      }
	  
      function roundUp200(n){
        if(!Number.isFinite(n) || n <= 0) return 200;
        return Math.max(200, Math.ceil(n / 200) * 200);
      }

      function renderGraph(){
        const cur = currentTour();
        const xMax = Math.max(1, cur);
        const lastComplete = Math.max(0, cur - 1);

        // Courbes: on s‚Äôarr√™te au dernier tour complet
        const totals = computeRunningTotals(lastComplete);

        // Max Y = max score, arrondi au multiple de 200 au-dessus
        let maxVal = 0;
        for(let i=1; i<=lastComplete; i++){
          const tot = totals[i];
          if(tot && tot.computed){
            if(tot.Nous > maxVal) maxVal = tot.Nous;
            if(tot.Eux > maxVal) maxVal = tot.Eux;
          }
        }
        const yMax = roundUp200(maxVal);

        const canvas = elGraphCanvas;
        const ctx = canvas.getContext('2d');
        if(!ctx) return;

        const rect = canvas.getBoundingClientRect();
        const cssW = Math.max(10, rect.width);
        const cssH = Math.max(10, rect.height);
        const dpr = window.devicePixelRatio || 1;

        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,cssW,cssH);

        const padL = 44, padR = 24, padT = 12, padB = 30;
        const w = cssW, h = cssH;
        const pw = w - padL - padR;
        const ph = h - padT - padB;

        ctx.font = '12px -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial';
        ctx.fillStyle = 'rgba(0,0,0,.55)';

        function xToPx(x){
          if(xMax <= 1) return padL;
          return padL + ((x - 1) / (xMax - 1)) * pw;
        }
        function yToPx(y){
          const yy = Math.max(0, Math.min(yMax, y));
          return padT + (1 - (yy / yMax)) * ph;
        }

        // Grille Y: pas de 200, labels all√©g√©s si besoin
        const steps = Math.max(1, Math.round(yMax / 200));
        const labelEvery = steps > 12 ? 2 : 1;

        ctx.strokeStyle = 'rgba(0,0,0,.10)';
        ctx.lineWidth = 1;

        for(let k=0; k<=steps; k++){
          const yVal = k * 200;
          const y = yToPx(yVal);

          ctx.beginPath();
          ctx.moveTo(padL, y);
          ctx.lineTo(padL + pw, y);
          ctx.stroke();

          if(k % labelEvery === 0){
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(yVal), padL - 6, y);
          }
        }

        // Axes
        ctx.strokeStyle = 'rgba(0,0,0,.28)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, padT + ph);
        ctx.lineTo(padL + pw, padT + ph);
        ctx.stroke();

        // Labels X: tours (jusqu‚Äôau tour en cours)
        ctx.fillStyle = 'rgba(0,0,0,.55)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        const xStep = xMax <= 12 ? 1 : Math.ceil(xMax / 10);
        for(let x=1; x<=xMax; x+=xStep){
          const xx = xToPx(x);
          ctx.fillText(String(x), xx, padT + ph + 6);
        }

        function drawSeries(team, color){
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;

          let last = null;
          let started = false;

          for(let i=1; i<=lastComplete; i++){
            const tot = totals[i];
            if(!tot || !tot.computed) continue;

            const xx = xToPx(i);
            const yy = yToPx(tot[team]);

            if(!started){
              ctx.beginPath();
              ctx.moveTo(xx, yy);
              started = true;
            }else{
              ctx.lineTo(xx, yy);
            }
            last = {x: xx, y: yy, val: tot[team], tour: i};
          }

          if(started) ctx.stroke();
          return last;
        }

        const blue = '#1f6fd2'; // Nous
        const red  = '#d21f1f'; // Eux

        const lastNous = drawSeries('Nous', blue);
        const lastEux  = drawSeries('Eux',  red);

        function drawDot(pt, color){
          if(!pt) return;
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI*2);
          ctx.fill();
        }
        drawDot(lastNous, blue);
        drawDot(lastEux, red);

        // Score final √† droite du dernier point
        let dyNous = 0, dyEux = 0;
        if(lastNous && lastEux && Math.abs(lastNous.y - lastEux.y) < 14){
          if(lastNous.y < lastEux.y){ dyNous = -8; dyEux = 8; }
          else { dyNous = 8; dyEux = -8; }
        }

        function drawEndLabel(pt, color, dy){
          if(!pt) return;
          ctx.fillStyle = color;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          const lx = Math.min(padL + pw + 6, pt.x + 8);
          const ly = pt.y + (dy || 0);
          ctx.fillText(String(pt.val), lx, ly);
        }
        drawEndLabel(lastNous, blue, dyNous);
        drawEndLabel(lastEux, red, dyEux);
      }
	  
      function renderStats(){
        if(!elStatsBody) return;

        const cur = currentTour();
        const last = Math.max(0, cur - 1); // tours valid√©s (Option A)
        const totals = computeRunningTotals(last);

        let totalNous = 0, totalEux = 0;
        if(last >= 1 && totals[last] && totals[last].computed){
          totalNous = totals[last].Nous;
          totalEux = totals[last].Eux;
        }

        const hasTours = last >= 1;

        // √âcart / leader
        const diff = totalNous - totalEux;
        let leaderText = '√âgalit√©';
        let leaderClass = '';
        if(diff > 0){ leaderText = `+${diff} Nous`; leaderClass = 'blue'; }
        else if(diff < 0){ leaderText = `+${(-diff)} Eux`; leaderClass = 'red'; }

        // Changements de leader (si >=2 tours)
        let leaderChanges = null;
        if(last >= 2){
          let prev = null;
          let changes = 0;
          for(let i=1; i<=last; i++){
            const tot = totals[i];
            if(!tot || !tot.computed) break;
            let lead = null;
            if(tot.Nous > tot.Eux) lead = 'Nous';
            else if(tot.Eux > tot.Nous) lead = 'Eux';
            if(lead && prev && lead !== prev) changes++;
            if(lead) prev = lead;
          }
          leaderChanges = changes;
        }

        // Points par tour (best/worst + swing)
        let bestNous = null, worstNous = null, bestEux = null, worstEux = null;
        let maxSwing = null;

        for(let i=1; i<=last; i++){
          const t = state.tours[String(i)];
          if(!t || !t.points) continue;
          const pn = t.points.Nous;
          const pe = t.points.Eux;
          if(!isFiniteNumber(pn) || !isFiniteNumber(pe)) continue;

          if(!bestNous || pn > bestNous.val) bestNous = {val: pn, tour: i};
          if(!worstNous || pn < worstNous.val) worstNous = {val: pn, tour: i};
          if(!bestEux || pe > bestEux.val) bestEux = {val: pe, tour: i};
          if(!worstEux || pe < worstEux.val) worstEux = {val: pe, tour: i};

          const d = pn - pe;
          const abs = Math.abs(d);
          if(!maxSwing || abs > maxSwing.abs){
            const win = d > 0 ? 'Nous' : d < 0 ? 'Eux' : '√âgal';
            maxSwing = {abs, tour: i, win, d};
          }
        }

        let lastSwingText = '‚Äî';
        if(hasTours){
          const t = state.tours[String(last)];
          if(t && t.points && isFiniteNumber(t.points.Nous) && isFiniteNumber(t.points.Eux)){
            const d = t.points.Nous - t.points.Eux;
            if(d > 0) lastSwingText = `+${d} Nous`;
            else if(d < 0) lastSwingText = `+${(-d)} Eux`;
            else lastSwingText = '0';
          }
        }

        const avgNous = hasTours ? Math.round(totalNous / last) : null;
        const avgEux  = hasTours ? Math.round(totalEux  / last) : null;

        // Contrats + couleurs + ‚Äúrares‚Äù
        const cCount = {Nous:0, Eux:0};
        const cOK = {Nous:0, Eux:0};
        const cFail = {Nous:0, Eux:0};
        const cSum = {Nous:0, Eux:0};
        const cC = {Nous:0, Eux:0};
        const cSC = {Nous:0, Eux:0};

        let maxContract = null; // {target, team, tour, contract}
        let lastCap = null, lastGen = null, lastC = null, lastSC = null;

        for(let i=1; i<=last; i++){
          const t = state.tours[String(i)];
          const c = t && t.contract ? t.contract : null;
          if(!c || !c.team) continue;

          const team = (c.team === 'Eux') ? 'Eux' : 'Nous';
          const target = contractTargetPoints(c);

          cCount[team]++;

          if(isFiniteNumber(target)){
            cSum[team] += target;
            if(!maxContract || target > maxContract.target){
              maxContract = {target, team, tour: i, contract: c};
            }
          }

          const ptsTeam = t && t.points ? t.points[team] : null;
          if(isFiniteNumber(target) && isFiniteNumber(ptsTeam)){
            if(ptsTeam >= target) cOK[team]++; else cFail[team]++;
          }

          if(c.coinche === 'SC'){ cSC[team]++; lastSC = {team, tour: i, contract: c}; }
          else if(c.coinche === 'C'){ cC[team]++; lastC = {team, tour: i, contract: c}; }

          if(c.kind === 'cap') lastCap = {team, tour: i, contract: c};
          if(c.kind === 'gen') lastGen = {team, tour: i, contract: c};

        }

        const anyContracts = (cCount.Nous + cCount.Eux) > 0;

        function pct(ok, total){
          if(total <= 0) return null;
          return Math.round((ok / total) * 100);
        }

        const pNous = pct(cOK.Nous, cCount.Nous);
        const pEux  = pct(cOK.Eux,  cCount.Eux);

        const avgCNous = cCount.Nous > 0 ? Math.round(cSum.Nous / cCount.Nous) : null;
        const avgCEux  = cCount.Eux  > 0 ? Math.round(cSum.Eux  / cCount.Eux)  : null;

        function suitHtml(id){
          const s = suitInfo(id);
          return `<span class="suit ${s.cls}">${escapeHtml(s.sym)}</span>`;
        }

        function contractHtml(c){
          if(!c) return '‚Äî';
          const coinche = (c.coinche === 'SC') ? 'SC' : (c.coinche === 'C' ? 'C' : '');
          if(c.kind === 'number'){
            return `<span class="contractInline">${escapeHtml(String(c.value))}${suitHtml(c.suit)}${coinche ? `<span class="coinche">${coinche}</span>` : ''}</span>`;
          }
          if(c.kind === 'cap'){
            return `<span class="contractInline">${suitHtml(c.suit)}Cap${coinche ? `<span class="coinche">${coinche}</span>` : ''}</span>`;
          }
          if(c.kind === 'gen'){
            return `<span class="contractInline">G√©n${suitHtml('none')}${coinche ? `<span class="coinche">${coinche}</span>` : ''}</span>`;
          }
          return '‚Äî';
        }

        // Champagne (toujours 3 lignes)
        const champ = [];
        champ.push({
          emoji: 'üèÜ',
          html: maxContract
            ? `Max contrat : <b>${maxContract.team}</b> ${contractHtml(maxContract.contract)} <span class="muted">(T${maxContract.tour})</span>`
            : `Max contrat : ‚Äî`
        });

        champ.push({
          emoji: 'üí•',
          html: maxSwing
            ? `Swing max : <b>${maxSwing.abs === 0 ? '0' : ('+'+maxSwing.abs)}</b> ${maxSwing.win} <span class="muted">(T${maxSwing.tour})</span>`
            : `Swing max : ‚Äî`
        });

        let extra = null;
        if(lastSC) extra = {emoji:'üß®', html:`Sur coinch√© : <b>${lastSC.team}</b> ${contractHtml(lastSC.contract)} <span class="muted">(T${lastSC.tour})</span>`};
        else if(lastC) extra = {emoji:'üéØ', html:`Coinch√© : <b>${lastC.team}</b> ${contractHtml(lastC.contract)} <span class="muted">(T${lastC.tour})</span>`};
        else if(lastGen) extra = {emoji:'üëë', html:`G√©n : <b>${lastGen.team}</b> ${contractHtml(lastGen.contract)} <span class="muted">(T${lastGen.tour})</span>`};
        else if(lastCap) extra = {emoji:'üçæ', html:`Cap : <b>${lastCap.team}</b> ${contractHtml(lastCap.contract)} <span class="muted">(T${lastCap.tour})</span>`};

        if(extra){
          champ.push(extra);
        }else{
          const bestOverall =
            (bestNous && bestEux)
              ? (bestNous.val >= bestEux.val ? {team:'Nous', val:bestNous.val, tour:bestNous.tour}
                                            : {team:'Eux',  val:bestEux.val,  tour:bestEux.tour})
              : (bestNous ? {team:'Nous', val:bestNous.val, tour:bestNous.tour}
                         : (bestEux ? {team:'Eux', val:bestEux.val, tour:bestEux.tour} : null));

          champ.push({
            emoji: '‚ú®',
            html: bestOverall ? `Meilleur tour : <b>${bestOverall.team}</b> +${bestOverall.val} <span class="muted">(T${bestOverall.tour})</span>`
                              : `Meilleur tour : ‚Äî`
          });
        }

        elStatsBody.innerHTML = `
          <div class="statCard">
            <div class="statHead">
              <div class="statHeadTitle">R√©sum√©</div>
              <div class="statHeadSub">Tours valid√©s : ${last} ‚Ä¢ Tour : ${cur}</div>
            </div>
            <div class="scoreRow">
              <div class="scoreBox nous">
                <div class="scoreName">Nous</div>
                <div class="scoreVal">${totalNous}</div>
              </div>
              <div class="scoreBox eux">
                <div class="scoreName">Eux</div>
                <div class="scoreVal">${totalEux}</div>
              </div>
            </div>
            <div class="deltaRow">
              <span class="pill ${leaderClass}">${escapeHtml(leaderText)}</span>
              <span class="small">Changements de leader : ${leaderChanges === null ? '‚Äî' : leaderChanges}</span>
            </div>
          </div>

          <div class="statCard">
            <div class="statHead">
              <div class="statHeadTitle">Rythme</div>
              <div class="statHeadSub">${hasTours ? `Dernier tour : ${escapeHtml(lastSwingText)}` : '‚Äî'}</div>
            </div>
            <div class="kpiGrid">
              <div class="kpi">
                <div class="kpiLabel">Nous</div>
                <div class="kpiValue">${avgNous === null ? '‚Äî' : avgNous}<span class="kpiUnit">/tour</span></div>
                <div class="kpiMini">Max : ${bestNous ? `+${bestNous.val} (T${bestNous.tour})` : '‚Äî'}</div>
                <div class="kpiMini">Min : ${worstNous ? `+${worstNous.val} (T${worstNous.tour})` : '‚Äî'}</div>
              </div>
              <div class="kpi">
                <div class="kpiLabel">Eux</div>
                <div class="kpiValue">${avgEux === null ? '‚Äî' : avgEux}<span class="kpiUnit">/tour</span></div>
                <div class="kpiMini">Max : ${bestEux ? `+${bestEux.val} (T${bestEux.tour})` : '‚Äî'}</div>
                <div class="kpiMini">Min : ${worstEux ? `+${worstEux.val} (T${worstEux.tour})` : '‚Äî'}</div>
              </div>
            </div>
          </div>

          <div class="statCard">
            <div class="statHead">
              <div class="statHeadTitle">Contrats</div>
              <div class="statHeadSub">${hasTours ? '' : '‚Äî'}</div>
            </div>
            <div class="kpiGrid">
              <div class="kpi">
                <div class="kpiLabel">Nous</div>
                <div class="kpiValue">${hasTours ? cCount.Nous : '‚Äî'}<span class="kpiUnit">annonc√©s</span></div>
                <div class="kpiMini">R√©ussite : ${pNous === null ? '‚Äî' : (pNous + '%')}</div>
                <div class="barWrap"><div class="barFill" style="width:${pNous === null ? 0 : pNous}%;"></div></div>
                <div class="kpiMini">Moyenne : ${avgCNous === null ? '‚Äî' : avgCNous}</div>
                <div class="kpiMini">Rat√©s : ${hasTours ? cFail.Nous : '‚Äî'}</div>
              </div>
              <div class="kpi">
                <div class="kpiLabel">Eux</div>
                <div class="kpiValue">${hasTours ? cCount.Eux : '‚Äî'}<span class="kpiUnit">annonc√©s</span></div>
                <div class="kpiMini">R√©ussite : ${pEux === null ? '‚Äî' : (pEux + '%')}</div>
                <div class="barWrap"><div class="barFill red" style="width:${pEux === null ? 0 : pEux}%;"></div></div>
                <div class="kpiMini">Moyenne : ${avgCEux === null ? '‚Äî' : avgCEux}</div>
                <div class="kpiMini">Rat√©s : ${hasTours ? cFail.Eux : '‚Äî'}</div>
              </div>
            </div>
            <div style="margin-top:10px;" class="small">C : ${hasTours ? cC.Nous : '‚Äî'} / ${hasTours ? cC.Eux : '‚Äî'} ‚Ä¢ SC : ${hasTours ? cSC.Nous : '‚Äî'} / ${hasTours ? cSC.Eux : '‚Äî'}</div>
          </div>

            <div class="suitBlock">
              <div class="suitLabel">Nous</div>
              <div class="suitGrid">
                ${suitChip('spade', suitsCount.Nous.spade)}
                ${suitChip('club', suitsCount.Nous.club)}
                ${suitChip('heart', suitsCount.Nous.heart)}
                ${suitChip('diamond', suitsCount.Nous.diamond)}
                ${suitChip('none', suitsCount.Nous.none)}
              </div>
            </div>

            <div class="suitBlock" style="margin-top:10px;">
              <div class="suitLabel">Eux</div>
              <div class="suitGrid">
                ${suitChip('spade', suitsCount.Eux.spade)}
                ${suitChip('club', suitsCount.Eux.club)}
                ${suitChip('heart', suitsCount.Eux.heart)}
                ${suitChip('diamond', suitsCount.Eux.diamond)}
                ${suitChip('none', suitsCount.Eux.none)}
              </div>
            </div>
          </div>

          <div class="statCard">
            <div class="statHead">
              <div class="statHeadTitle">Champagne</div>
              <div class="statHeadSub"></div>
            </div>
            <ul class="champList">
              ${champ.slice(0,3).map(it => `
                <li class="champItem">
                  <div class="emoji">${it.emoji}</div>
                  <div class="txt">${it.html}</div>
                </li>
              `).join('')}
            </ul>
          </div>
          
        `;
      }

      function renderContractFragment(contract){
        const frag = document.createDocumentFragment();

        const coinche = contract.coinche || 'none';
        const suit = contract.suit || 'spade';

        if(contract.kind === 'number'){
          frag.appendChild(document.createTextNode(String(contract.value)));
          frag.appendChild(renderSuitSpan(suit));
        }else if(contract.kind === 'cap'){
          frag.appendChild(renderSuitSpan(suit));
          frag.appendChild(document.createTextNode('Cap'));
        }else if(contract.kind === 'gen'){
          frag.appendChild(document.createTextNode('G√©n'));
          frag.appendChild(renderSuitSpan('none'));
        }else{
          frag.appendChild(document.createTextNode('‚Äî'));
        }

        if(coinche === 'C' || coinche === 'SC'){
          const c = document.createElement('span');
          c.className = 'coinche';
          c.textContent = coinche;
          frag.appendChild(c);
        }
        return frag;
      }

      function renderSuitSpan(suitId){
        const s = suitInfo(suitId);
        const sp = document.createElement('span');
        sp.className = 'suit ' + s.cls;
        sp.textContent = s.sym;
        return sp;
      }

      // -------- Panel handling ----------
      const overlay = document.getElementById('overlay');
      const panel = document.getElementById('panel');
      const panelTitle = document.getElementById('panelTitle');
      const panelBody = document.getElementById('panelBody');
      const panelClose = document.getElementById('panelClose');

      const btnContrat = document.getElementById('btnContrat');
      const btnPoints  = document.getElementById('btnPoints');
      const btnAutres  = document.getElementById('btnAutres');

      let activePanel = null; // 'contrat'|'points'|'autres'|null

      function openPanel(which){
        activePanel = which;
        panelTitle.textContent = which === 'contrat' ? 'Contrat' : (which === 'points' ? 'Points' : 'Autres');

        if(which === 'contrat') renderPanelContrat();
        if(which === 'points')  renderPanelPoints();
        if(which === 'autres')  renderPanelAutres();

        overlay.classList.add('open');
        panel.classList.add('open');
        renderBarActive();
      }

      function closePanel(){
        activePanel = null;
        placementOpen = false; // replier "Placement" √† chaque fermeture
        overlay.classList.remove('open');
        panel.classList.remove('open');
        renderBarActive();
      }

      function renderBarActive(){
        const map = {contrat: btnContrat, points: btnPoints, autres: btnAutres};
        for(const k of Object.keys(map)){
          map[k].classList.toggle('active', activePanel === k);
        }
      }

      overlay.addEventListener('click', closePanel);
      panelClose.addEventListener('click', closePanel);

      btnContrat.addEventListener('click', () => openPanel('contrat'));
      btnPoints.addEventListener('click',  () => openPanel('points'));
      btnAutres.addEventListener('click',  () => openPanel('autres'));

      // -------- Panel: Contrat ----------
      function renderPanelContrat(){
        const cur = currentTour();

        panelBody.innerHTML = `
          <div class="field">
            <label class="label" for="cTour">Tour</label>
            <input id="cTour" type="number" min="1" step="1" inputmode="numeric"/>
          </div>

          <div class="field">
            <label class="label" for="cWho">Qui</label>
            <select id="cWho">
              <option value="Nous">Nous</option>
              <option value="Eux">Eux</option>
            </select>
          </div>

          <div class="field">
            <span class="label">Couleur</span>
            <div class="suitPick" id="cSuitPick" role="radiogroup" aria-label="Couleur">
              ${SUITS.map(s => `
                <button type="button" class="suitBtn" data-suit="${s.id}" aria-pressed="false" title="${s.sym}">
                  <span class="suit ${s.cls}">${s.sym}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="field">
            <span class="label">Points</span>
            <div class="seg" id="cKind">
              <button type="button" data-kind="number">Nombre</button>
              <button type="button" data-kind="gen">G√©n</button>
              <button type="button" data-kind="cap">Cap</button>
            </div>
            <div id="cNumberWrap" style="margin-top:10px;">
              <input id="cValue" type="number" min="0" step="10" inputmode="numeric" placeholder="000"/>
            </div>
          </div>

          <div class="field">
            <label class="label" for="cCoinche">Coinch√©</label>
            <select id="cCoinche">
              <option value="none">‚Äî</option>
              <option value="C">Coinch√©</option>
              <option value="SC">Sur coinch√©</option>
            </select>
          </div>

          <button class="primary" id="cSave">Valider</button>
          <div class="error" id="cError" style="display:none;"></div>
        `;

        const cTour = document.getElementById('cTour');
        const cWho = document.getElementById('cWho');
        const cCoinche = document.getElementById('cCoinche');
        const cError = document.getElementById('cError');
        const suitPick = document.getElementById('cSuitPick');
        const kindWrap = document.getElementById('cKind');
        const numberWrap = document.getElementById('cNumberWrap');
        const cValue = document.getElementById('cValue');

        // Defaults
        cTour.value = String(cur);
        let selectedSuit = 'spade';
        let selectedKind = 'number';

        // Prefill if existing
        prefillContrat(cur);

        function setError(msg){
          if(!msg){
            cError.style.display = 'none';
            cError.textContent = '';
            return;
          }
          cError.style.display = 'block';
          cError.textContent = msg;
        }

        function setSuit(id){
          selectedSuit = id;
          const btns = suitPick.querySelectorAll('button.suitBtn');
          btns.forEach(b => {
            const on = b.getAttribute('data-suit') === id;
            b.classList.toggle('on', on);
            b.setAttribute('aria-pressed', on ? 'true' : 'false');
          });
        }

        function setKind(kind){
          selectedKind = kind;
          const btns = kindWrap.querySelectorAll('button');
          btns.forEach(b => b.classList.toggle('on', b.getAttribute('data-kind') === kind));
          if(kind === 'number'){
            numberWrap.style.display = 'block';
            // enable suit picker
            toggleSuitPickerDisabled(false);
          }else{
            numberWrap.style.display = 'none';
          }
          if(kind === 'gen'){
            setSuit('none');
            toggleSuitPickerDisabled(true); // only '-' is allowed
          }else if(kind === 'cap'){
            toggleSuitPickerDisabled(false);
          }
        }

        function toggleSuitPickerDisabled(disabled){
          const btns = suitPick.querySelectorAll('button.suitBtn');
          btns.forEach(b => {
            const id = b.getAttribute('data-suit');
            if(disabled){
              b.disabled = (id !== 'none');
            }else{
              b.disabled = false;
            }
          });
        }

        suitPick.addEventListener('click', (e) => {
          const btn = e.target.closest('button.suitBtn');
          if(!btn) return;
          const id = btn.getAttribute('data-suit');
          setSuit(id);
        });

        kindWrap.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-kind]');
          if(!btn) return;
          setKind(btn.getAttribute('data-kind'));
        });

        cTour.addEventListener('change', () => {
          const t = parseIntSafe(cTour.value);
          if(!t || t < 1){
            cTour.value = String(cur);
            prefillContrat(cur);
            return;
          }
          prefillContrat(t);
        });

        function prefillContrat(tour){
          ensureTour(tour);
          const t = state.tours[String(tour)];
          const c = t && t.contract ? t.contract : null;

          // reset defaults
          setKind('number');
          setSuit('spade');
          cWho.value = 'Nous';
          cCoinche.value = 'none';
          cValue.value = '';

          if(c){
            cWho.value = c.team || 'Nous';
            cCoinche.value = c.coinche || 'none';

            if(c.kind === 'number'){
              setKind('number');
              cValue.value = isFiniteNumber(c.value) ? String(c.value) : '';
              setSuit(c.suit || 'spade');
            }else if(c.kind === 'cap'){
              setKind('cap');
              setSuit(c.suit || 'spade');
            }else if(c.kind === 'gen'){
              setKind('gen');
              setSuit('none');
            }
          }
          setError('');
        }

        document.getElementById('cSave').addEventListener('click', () => {
          setError('');

          const tour = parseIntSafe(cTour.value);
          if(!tour || tour < 1){
            setError('Tour invalide.');
            return;
          }

          const team = cWho.value === 'Eux' ? 'Eux' : 'Nous';
          const coinche = cCoinche.value || 'none';

          let contract = { team, coinche: coinche === 'C' ? 'C' : (coinche === 'SC' ? 'SC' : 'none') };

          if(selectedKind === 'number'){
            const v = Number.parseInt(String(cValue.value || ''), 10);
            if(!Number.isFinite(v)){
              setError('Entre un nombre de points.');
              return;
            }
            if(selectedSuit === 'none'){
              setError('Choisis une couleur (sauf g√©n√©rale).');
              return;
            }
            contract.kind = 'number';
            contract.value = v;
            contract.suit = selectedSuit;
          }else if(selectedKind === 'cap'){
            if(selectedSuit === 'none'){
              setError('Choisis une couleur pour Cap.');
              return;
            }
            contract.kind = 'cap';
            contract.value = null;
            contract.suit = selectedSuit;
          }else if(selectedKind === 'gen'){
            contract.kind = 'gen';
            contract.value = null;
            contract.suit = 'none';
          }else{
            setError('Contrat invalide.');
            return;
          }

          const existing = state.tours[String(tour)] && state.tours[String(tour)].contract;
          if(existing && existing.team && existing.team !== team){
            setError('L‚Äôautre √©quipe est d√©j√† partie, il faut supprimer son contrat avant d‚Äôen entrer un autre');
            return;
          }

          pushHistory(makeUndoLabel('Contrat', team, tour));
          const t = ensureTour(tour);
          t.contract = contract;
		  
			saveState();
			renderAll();
			closePanel();
        });

        // init kind default + suit highlight
        setKind(selectedKind);
        setSuit(selectedSuit);
      }

      // -------- Panel: Points ----------
      function renderPanelPoints(){
        const cur = currentTour();

        panelBody.innerHTML = `
          <div class="field">
            <label class="label" for="pTour">Tour</label>
            <input id="pTour" type="number" min="1" step="1" inputmode="numeric"/>
          </div>

          <div class="field">
            <label class="label" for="pWho">Qui</label>
            <select id="pWho">
              <option value="Nous">Nous</option>
              <option value="Eux">Eux</option>
            </select>
          </div>

          <div class="field">
            <label class="label" for="pValue">Points</label>
            <input id="pValue" type="number" step="1" inputmode="numeric" placeholder="000"/>
          </div>

          <button class="primary" id="pSave">Valider</button>
          <div class="error" id="pError" style="display:none;"></div>
        `;

        const pTour = document.getElementById('pTour');
        const pWho = document.getElementById('pWho');
        const pValue = document.getElementById('pValue');
        const pError = document.getElementById('pError');

        pTour.value = String(cur);
        const who0 = suggestWhoForTour(cur);
        pWho.value = who0;

        prefillPoints(cur, who0);

        function setError(msg){
          if(!msg){
            pError.style.display = 'none';
            pError.textContent = '';
            return;
          }
          pError.style.display = 'block';
          pError.textContent = msg;
        }
		
        function suggestWhoForTour(tour){
          const t = state.tours[String(tour)];
          const pn = t && t.points ? t.points.Nous : null;
          const pe = t && t.points ? t.points.Eux : null;

          const hasNous = isFiniteNumber(pn);
          const hasEux  = isFiniteNumber(pe);

          // Aucun point sur le tour : on prend l‚Äô√©quipe partie (contrat) si dispo
          if(!hasNous && !hasEux){
            const ct = t && t.contract ? t.contract.team : null;
            return (ct === 'Nous' || ct === 'Eux') ? ct : 'Nous';
          }

          // Un seul c√¥t√© rempli : on propose l‚Äôautre
          if(hasNous && !hasEux) return 'Eux';
          if(!hasNous && hasEux) return 'Nous';

          // Sinon : d√©faut
          return 'Nous';
        }

        function prefillPoints(tour, team){
          ensureTour(tour);
          const t = state.tours[String(tour)];
          const v = t && t.points ? t.points[team] : null;
          pValue.value = isFiniteNumber(v) ? String(v) : '';
          setError('');
        }

        pTour.addEventListener('change', () => {
          const tour = parseIntSafe(pTour.value);
          if(!tour || tour < 1){
            pTour.value = String(cur);
            const who = suggestWhoForTour(cur);
            pWho.value = who;
            prefillPoints(cur, who);
            return;
          }
          const who = suggestWhoForTour(tour);
          pWho.value = who;
          prefillPoints(tour, who);
        });

        pWho.addEventListener('change', () => {
          const tour = parseIntSafe(pTour.value) || cur;
          prefillPoints(tour, pWho.value);
        });

        document.getElementById('pSave').addEventListener('click', () => {
          setError('');

          const tour = parseIntSafe(pTour.value);
          if(!tour || tour < 1){
            setError('Tour invalide.');
            return;
          }
          const team = pWho.value === 'Eux' ? 'Eux' : 'Nous';
          const v = Number.parseInt(String(pValue.value || ''), 10);
          if(!Number.isFinite(v)){
            setError('Entre un nombre de points.');
            return;
          }
		  
          const before = state.tours[String(tour)];
          const wasComplete = !!(before && before.points && isFiniteNumber(before.points.Nous) && isFiniteNumber(before.points.Eux));

          pushHistory(makeUndoLabel('Points', team, tour));
          const t = ensureTour(tour);
          t.points[team] = v;

			saveState();
			renderAll();

          const nowComplete = isFiniteNumber(t.points.Nous) && isFiniteNumber(t.points.Eux);

          // Si on vient de compl√©ter le tour (2 √©quipes), on ferme
          if(!wasComplete && nowComplete){
            closePanel();
            return;
          }

          // Sinon, on pr√©pare la saisie suivante (souvent l‚Äôautre √©quipe)
          if(!nowComplete){
            const nextTeam = suggestWhoForTour(tour);
            pWho.value = nextTeam;
            prefillPoints(tour, nextTeam);
          }else{
            prefillPoints(tour, team);
          }

          pValue.focus();
          pValue.select();
		  
        });
      }

      // -------- Panel: Autres ----------

      function renderPanelAutres(){
        const undoLabel = state.undo.length ? state.undo[state.undo.length-1].label : '‚Äî';

        // Placement : normalisation
        state.players = normalizePlayers(state.players);
        const p = state.players;

        const p1Preset = PRESET_PLAYERS.includes(p[0]);
        const p2Preset = PRESET_PLAYERS.includes(p[1]);
        const p3Preset = PRESET_PLAYERS.includes(p[2]);
        const p4Preset = PRESET_PLAYERS.includes(p[3]);

        const opt1 = PRESET_PLAYERS.map(n => `<option value="${escapeHtml(n)}" ${p[0]===n ? 'selected' : ''}>${escapeHtml(n)}</option>`).join('') +
                     `<option value="${OTHER_VALUE}" ${p1Preset ? '' : 'selected'}>Autre</option>`;
        const opt2 = PRESET_PLAYERS.map(n => `<option value="${escapeHtml(n)}" ${p[1]===n ? 'selected' : ''}>${escapeHtml(n)}</option>`).join('') +
                     `<option value="${OTHER_VALUE}" ${p2Preset ? '' : 'selected'}>Autre</option>`;
        const opt3 = PRESET_PLAYERS.map(n => `<option value="${escapeHtml(n)}" ${p[2]===n ? 'selected' : ''}>${escapeHtml(n)}</option>`).join('') +
                     `<option value="${OTHER_VALUE}" ${p3Preset ? '' : 'selected'}>Autre</option>`;
        const opt4 = PRESET_PLAYERS.map(n => `<option value="${escapeHtml(n)}" ${p[3]===n ? 'selected' : ''}>${escapeHtml(n)}</option>`).join('') +
                     `<option value="${OTHER_VALUE}" ${p4Preset ? '' : 'selected'}>Autre</option>`;

        panelBody.innerHTML = `
          <div class="actionsRow">
            <button class="danger" id="aReset">Nouvelle partie</button>
          </div>

          <div class="field" style="margin-top:18px;">
            <button class="primary" id="aUndo" ${state.undo.length ? '' : 'disabled'}>Undo</button>
            <div class="miniLabel">Dernier : ${escapeHtml(undoLabel)}</div>
          </div>

          <div class="field">
            <button class="primary" id="aPlacement">Placement</button>

            <div id="placementBox" style="display:${placementOpen ? 'block' : 'none'}; margin-top:10px;">
              <div class="rowInline">
                <div>
                  <select id="pl1Sel">${opt1}</select>
                  <input id="pl1Other" type="text" autocomplete="off" placeholder="Nom"
                         style="display:${p1Preset ? 'none' : 'block'}; margin-top:8px;"
                         value="${p1Preset ? '' : escapeHtml(p[0])}"/>
                </div>
                <div>
                  <select id="pl2Sel">${opt2}</select>
                  <input id="pl2Other" type="text" autocomplete="off" placeholder="Nom"
                         style="display:${p2Preset ? 'none' : 'block'}; margin-top:8px;"
                         value="${p2Preset ? '' : escapeHtml(p[1])}"/>
                </div>
              </div>

              <div class="rowInline" style="margin-top:10px;">
                <div>
                  <select id="pl3Sel">${opt3}</select>
                  <input id="pl3Other" type="text" autocomplete="off" placeholder="Nom"
                         style="display:${p3Preset ? 'none' : 'block'}; margin-top:8px;"
                         value="${p3Preset ? '' : escapeHtml(p[2])}"/>
                </div>
                <div>
                  <select id="pl4Sel">${opt4}</select>
                  <input id="pl4Other" type="text" autocomplete="off" placeholder="Nom"
                         style="display:${p4Preset ? 'none' : 'block'}; margin-top:8px;"
                         value="${p4Preset ? '' : escapeHtml(p[3])}"/>
                </div>
              </div>

              <div class="field" style="margin-top:12px;">
                <label class="label" for="plDealer">Qui donne ?</label>
                <select id="plDealer"></select>
              </div>
            </div>
          </div>

          <div class="field">
            <button class="primary" id="aGraph">Graphique</button>
          </div>
		  
          <div class="field">
            <button class="primary" id="aStats">Statistiques</button>
          </div>
		  
        `;

        document.getElementById('aReset').addEventListener('click', () => {
          const ok = confirm('Nouvelle partie : tu confirmes ?');
          if(ok) resetGame();
        });

        const undoBtn = document.getElementById('aUndo');
        undoBtn.addEventListener('click', () => {
          doUndo();
          renderPanelAutres();
        });

        document.getElementById('aPlacement').addEventListener('click', () => {
          placementOpen = !placementOpen;
          const box = document.getElementById('placementBox');
          if(box) box.style.display = placementOpen ? 'block' : 'none';
        });

        const pl1Sel = document.getElementById('pl1Sel');
        const pl2Sel = document.getElementById('pl2Sel');
        const pl3Sel = document.getElementById('pl3Sel');
        const pl4Sel = document.getElementById('pl4Sel');

        const pl1Other = document.getElementById('pl1Other');
        const pl2Other = document.getElementById('pl2Other');
        const pl3Other = document.getElementById('pl3Other');
        const pl4Other = document.getElementById('pl4Other');

        const plDealer = document.getElementById('plDealer');

        function setOtherVisibility(sel, other){
          if(!sel || !other) return;
          other.style.display = (sel.value === OTHER_VALUE) ? 'block' : 'none';
        }

        function seatName(sel, other, fallback){
          if(!sel) return fallback;
          if(sel.value === OTHER_VALUE){
            const v = String(other ? other.value : '').trim();
            return v ? v : 'Autre';
          }
          return sel.value;
        }

        function rebuildDealerOptions(){
          if(!plDealer) return;
          const keep = parseIntSafe(plDealer.value);

          plDealer.innerHTML = state.players.map((name, idx) =>
            `<option value="${idx}">${escapeHtml(name)}</option>`
          ).join('');

          const curIdx = dealerIndexForTour(currentTour());
          const next = (keep !== null && keep >= 0 && keep <= 3) ? keep : curIdx;
          plDealer.value = String(next);
        }

        function syncPlayersFromUI(){
          state.players = [
            seatName(pl1Sel, pl1Other, PRESET_PLAYERS[0]),
            seatName(pl2Sel, pl2Other, PRESET_PLAYERS[1]),
            seatName(pl3Sel, pl3Other, PRESET_PLAYERS[2]),
            seatName(pl4Sel, pl4Other, PRESET_PLAYERS[3]),
          ];
          saveState();
          rebuildDealerOptions();
          renderDealerGrid();
        }

        if(pl1Sel) pl1Sel.addEventListener('change', () => { setOtherVisibility(pl1Sel, pl1Other); syncPlayersFromUI(); });
        if(pl2Sel) pl2Sel.addEventListener('change', () => { setOtherVisibility(pl2Sel, pl2Other); syncPlayersFromUI(); });
        if(pl3Sel) pl3Sel.addEventListener('change', () => { setOtherVisibility(pl3Sel, pl3Other); syncPlayersFromUI(); });
        if(pl4Sel) pl4Sel.addEventListener('change', () => { setOtherVisibility(pl4Sel, pl4Other); syncPlayersFromUI(); });

        if(pl1Other) pl1Other.addEventListener('input', syncPlayersFromUI);
        if(pl2Other) pl2Other.addEventListener('input', syncPlayersFromUI);
        if(pl3Other) pl3Other.addEventListener('input', syncPlayersFromUI);
        if(pl4Other) pl4Other.addEventListener('input', syncPlayersFromUI);

        // Donneur = tour en cours : recale la rotation √† partir de maintenant
        if(plDealer){
          rebuildDealerOptions();
          plDealer.value = String(dealerIndexForTour(currentTour()));

          plDealer.addEventListener('change', () => {
            const idx = parseIntSafe(plDealer.value);
            const t = currentTour();
            state.dealerAnchorTour = t;
            state.dealerAnchorIndex = (idx !== null && idx >= 0 && idx <= 3) ? idx : 0;
            saveState();
            renderDealerGrid();
          });
        }

        document.getElementById('aGraph').addEventListener('click', () => {
          showingGraph = true;
          showingStats = false;
          closePanel();
          renderAll();
        });
		
        document.getElementById('aStats').addEventListener('click', () => {
          showingStats = true;
          showingGraph = false;
          closePanel();
          renderAll();
        });
		
      }
	  
      function escapeHtml(s){
        return String(s || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      // Initial render
      renderAll();
	  
      window.addEventListener('resize', () => {
        if(showingGraph) renderGraph();
      });

      // Keyboard: Esc closes panel (desktop)
      window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && activePanel) closePanel();
      });

    })();
  </script>
</body>
</html>
